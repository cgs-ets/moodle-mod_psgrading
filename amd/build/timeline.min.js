define(["jquery","core/log","core/config","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events","mod_psgrading/recipientselector"],function(u,f,e,d,i,t,l,o,a){"use strict";function n(e){var t=this;t.rootel=e,t.component="mod_psgrading",t.overlay=u("#psgrading-overlay"),t.templates={SLIDER:"mod_psgrading/slider",EXPORTRESULT:"mod_psgrading/export_result"},t.modals={EXPORTRESULT:null}}return n.prototype.main=function(){var t=this;t.rootel.on("click",".display-options a",function(e){e.preventDefault();e=u(this);t.display(e)}),t.rootel.on("click",".recipient-result",function(e){e.preventDefault();e=u(this);window.location.href=e.data("timelineurl")}),t.rootel.on("click",".link-reply",function(e){e.preventDefault();e=u(this);t.expandReply(e)}),t.rootel.on("click",".link-post-reply",function(e){e.preventDefault();e=u(this);t.postReply(e)}),t.rootel.on("click",".link-post-cancel",function(e){e.preventDefault();e=u(this);t.cancelReply(e)}),t.rootel.on("click",".thread-reply",function(e){e.preventDefault();e=u(this).closest(".reply");e.addClass("replying"),e.find(".reply-comment").focus()}),t.rootel.on("click",".post-thread-reply",function(e){e.preventDefault();e=u(this);t.postThreadReply(e)}),t.rootel.on("click",".slide-trigger",function(e){e.preventDefault();e=u(this);t.displaySlide(e)}),t.rootel.on("click",".slider .nav",function(e){e.preventDefault(),e.stopPropagation();e=u(this);t.navSlider(e)}),t.rootel.on("click",".slider",function(e){e.preventDefault();e=u(this);t.closeSlider(e)}),t.rootel.on("click",".delete-post",function(e){e.preventDefault();e=u(this);t.delete(e)}),t.rootel.on("click",".delete-reply",function(e){e.preventDefault();e=u(this);t.deleteReply(e)}),t.rootel.on("click",".expand-recipients",function(e){e.preventDefault();e=u(this);t.expandRecipients(e)}),t.rootel.on("click",".reply-to-selector",function(e){e.preventDefault();e=u(this);t.showReplyToRecipients(e)}),t.rootel.on("click",".reply-to-recipient",function(e){e.preventDefault();e=u(this);t.changeReplyToRecipient(e)}),t.rootel.on("click",".conversation",function(e){e.preventDefault();e=u(this);t.showConversation(e)}),t.rootel.on("click",".btn-export",function(e){e.preventDefault(),t.export()}),u(".path-local-psgrading").on("click",".download-export-link ",function(e){t.modals.EXPORTRESULT.getModal(),t.modals.EXPORTRESULT.hide()}),"undefined"!=typeof InfiniteScroll&&new InfiniteScroll(".mod_psgrading .list",{path:".next",append:".post",history:!1,status:".page-load-status"});a.init(["user","board"],["student","staff"]),t.rootel.removeClass("loadingjs");var e=[];e.push(t.loadModal("EXPORTRESULT","Export to zip","",l.types.DEFAULT)),u.when.apply(u,e).then(function(){t.rootel.addClass("preloads-completed")})},n.prototype.display=function(e){e=e.data("option");this.rootel.removeClass(function(e,t){return(t.match(/(^|\s)display-\S+/g)||[]).join(" ")}).addClass(e)},n.prototype.postReply=function(e){var t,o,a=this,i=e.closest(".post"),l=i.find(".reply-comment");0!=l.val().trim().length&&(t=i.data("id"),0!=(o=i.data("postsusersid"))||(e=i.find(".reply-to-selected")).length&&(o=e.attr("data-replyto")),i.removeClass("replying"),i.addClass("submitting-reply"),d.call([{methodname:"mod_psgrading_post_reply",args:{postid:t,postsusersid:o,comment:l.val()},done:function(e){i.removeClass("submitting-reply"),l.val(""),a.loadReplies(t,o,e)},fail:function(e){i.removeClass("submitting-reply"),f.error("mod_psgrading/timeline: failed to post a reply."),f.debug(e)}}]))},n.prototype.cancelReply=function(e){var t=e.closest(".post"),o=t.find(".reply-comment"),e=t.find(".reply-to-dropdown");t.removeClass("replying"),o.val(""),e.hide()},n.prototype.postThreadReply=function(e){var t=this,o=e.closest(".post"),a=o.data("id"),e=e.closest(".reply"),i=o.data("postsusersid"),l=e.find(".reply-comment");0!=l.val().trim().length&&(e.removeClass("replying"),o.addClass("submitting-reply"),d.call([{methodname:"mod_psgrading_post_thread_reply",args:{postid:a,postsusersid:i,replyid:e.data("id"),comment:l.val()},done:function(e){o.removeClass("submitting-reply"),l.val(""),t.loadReplies(a,i,e)},fail:function(e){o.removeClass("submitting-reply"),f.error("mod_psgrading/timeline: failed to post a thread reply."),f.debug(e)}}]))},n.prototype.loadReplies=function(a,i,l){var n,s=this,r=s.rootel.find('.post[data-id="'+a+'"]').first();r.length?(n=r.find(".post-replies"),r.addClass("loading-replies"),d.call([{methodname:"mod_psgrading_load_replies",args:{postid:a,postsusersid:i,timelineuser:s.rootel.data("timelineuser")},done:function(e){n.replaceWith(e.html).hide();var t,o=r.find('.reply[data-id="'+l+'"]').first();r.hasClass("has-multiple")?(t=o.attr("data-conversationusername"),(e=r.find('.conversation[data-conversationusername="'+t+'"]').first()).length?(e.click(),r.removeClass("loading-replies"),o.addClass("just-created")):d.call([{methodname:"mod_psgrading_load_conversations",args:{postid:a,timelineuser:s.rootel.data("timelineuser")},done:function(e){r.find(".conversations").first().replaceWith(e.html),r.find('.conversation[data-conversationusername="'+t+'"]').first().click(),r.removeClass("loading-replies"),o.addClass("just-created")},fail:function(e){r.removeClass("loading-replies"),f.error("mod_psgrading/timeline: failed to load replies for post id: "+a+", postsusersid: "+i),f.debug(e)}}])):(r.removeClass("loading-replies"),o.addClass("just-created"))},fail:function(e){r.removeClass("loading-replies"),f.error("mod_psgrading/timeline: failed to load replies for post id: "+a+", postsusersid: "+i),f.debug(e)}}])):f.error("mod_psgrading/timeline.loadReplies: element .post[data-id="+a+"] not found.")},n.prototype.displaySlide=function(o){var t=this;t.overlay.addClass("active loading");var a=o.closest(".post"),e=a.find(".slider");if(e.length)return(p=a.find(".slide")).each(function(e){var t=u(this);t.removeClass("current"),t.data("src")==o.attr("href")&&t.addClass("current")}),e.addClass("active"),void t.overlay.removeClass("loading");var d=o.attr("href"),p=[],e=a.find(".slide-trigger"),c=1;e.each(function(e){var t=u(this).attr("href"),o=u(this).data("isimage")||0,a=u(this).data("isvideo")||0,i=u(this).data("isdoc")||0,l=u(this).data("iconimage")||"",n=u(this).data("filename")||"",s=u(this).data("mimetype")||"",r=t==d?!0:!1;p.push({id:c,src:t,iscurrent:r,isimage:o,isvideo:a,isdoc:i,iconimage:l,filename:n,mimetype:s}),c++});e={count:e.length,slides:p};i.render(t.templates.SLIDER,e).done(function(e){a.append(e),t.overlay.removeClass("loading")}).fail(function(e){f.debug(e)})},n.prototype.closeSlider=function(e){e.removeClass("active"),this.overlay.removeClass("active")},n.prototype.navSlider=function(e){var t=e.closest(".slider"),o=e.data("nav"),e=t.find(".slide.current"),o=e.data("id")+o;o>t.data("count")&&(o=1),0==o&&(o=t.data("count"));o=t.find('.slide[data-id="'+o+'"]');o.length&&(e.removeClass("current"),o.addClass("current"))},n.prototype.approve=function(e){var t=e.closest(".post"),e=t.data("id");t.addClass("submitting"),d.call([{methodname:"mod_psgrading_approve_post",args:{id:e},done:function(e){t.removeClass("submitting"),t.removeClass("unapproved")},fail:function(e){t.removeClass("submitting"),f.error("mod_psgrading/timeline: failed to approve the post"),f.debug(e)}}])},n.prototype.delete=function(e){var t=e.closest(".post"),o=t.data("id");t.addClass("submitting"),d.call([{methodname:"mod_psgrading_delete_post",args:{id:o},done:function(e){t.removeClass("submitting"),t.addClass("removing"),t.fadeOut(1e3,function(){t.remove()})},fail:function(e){t.removeClass("submitting"),f.error("mod_psgrading/timeline: failed to delete the post "+o),f.debug(e)}}])},n.prototype.deleteReply=function(e){var o=this,a=e.closest(".reply"),t=a.data("id"),i=a.data("poststhreadsid"),l=a.data("depth");a.addClass("deleting"),d.call([{methodname:"mod_psgrading_delete_reply",args:{id:t},done:function(e){var t;a.removeClass("deleting"),0==l?((t=o.rootel.find('.reply[data-poststhreadsid="'+i+'"]')).push(a),t.addClass("removing"),t.fadeOut(1e3,function(){a.remove()})):(a.addClass("removing"),a.fadeOut(1e3,function(){a.remove()}))},fail:function(e){a.removeClass("deleting"),f.error("mod_psgrading/timeline: failed to delete the reply "+t),f.debug(e)}}])},n.prototype.expandReply=function(e){self=this;var t=e.closest(".post");t.addClass("replying"),t.find(".reply-comment").focus();e=t.find(".conversation.active").first();e.length&&t.find('.reply-to-recipient[data-option="'+e.data("postsusersid")+'"]').click()},n.prototype.expandRecipients=function(e){e.hide(),e.closest(".post").find(".recipients").addClass("expanded").removeClass("collapsed")},n.prototype.showReplyToRecipients=function(e){e.next().fadeIn(200)},n.prototype.changeReplyToRecipient=function(e){var t=e.closest(".reply-to-dropdown"),o=e.closest(".reply-to").find(".reply-to-selected");o.attr("data-replyto",e.data("option")),o.html(e.attr("title")),t.slideUp(200)},n.prototype.showConversation=function(e){var t=e.closest(".post"),o=e.data("conversationusername");t.find(".conversation").removeClass("active"),e.addClass("active"),t.find(".reply").hide();o=t.find('.reply[data-conversationusername="'+o+'"], .reply[data-toeveryone="1"]'),t=t.find();o.fadeIn(200),t.fadeIn(200),e.find(".replycount").html(o.length)},n.prototype.loadModal=function(t,o,a,e){var i=this;return l.create({type:e}).then(function(e){e.setTitle(o),a&&e.setSaveButtonText(a),(i.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},n.prototype.export=function(){var o=this;o.modals.EXPORTRESULT&&(o.overlay.addClass("active loading"),d.call([{methodname:"mod_psgrading_export",args:{timeline:o.rootel.data("timelineuser")},done:function(e){if("failed"==e.code)return o.overlay.removeClass("active loading"),void f.error("mod_psgrading/timeline: failed to export timeline: "+e.data);var t={};"existinginprogress"==e.code?t.existinginprogress=!0:"existingready"==e.code?(t.existingready=!0,t.downloadurl=e.data):"ready"==e.code&&(t.ready=!0,t.downloadurl=e.data),i.render(o.templates.EXPORTRESULT,t).done(function(e){o.modals.EXPORTRESULT.getModal(),o.modals.EXPORTRESULT.setBody(e),o.modals.EXPORTRESULT.show(),o.overlay.removeClass("active loading")})},fail:function(e){o.overlay.removeClass("active loading"),f.error("mod_psgrading/timeline: failed to export timeline: "+o.rootel.data("timelineuser")),f.debug(e)}}]))},n.prototype.loadTemplate=function(e){return i.render(this.templates[e],{})},n.prototype.loadModal=function(t,o,a,e){var i=this;return l.create({type:e}).then(function(e){e.setTitle(o),a&&e.setSaveButtonText(a),(i.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},{init:function(e){f.debug("mod_psgrading/timeline: initializing");var t=u(e).first();t.length?new n(t).main():f.error("mod_psgrading/timeline: "+e+" element not found!")}}});