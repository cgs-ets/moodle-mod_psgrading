define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(a,d,i,r,l,s){"use strict";function n(e,t,o){var a=this;a.rootel=e,a.year=t,a.period=o}return n.prototype.main=function(){var t=this;t.rootel.on("click",".report-element",function(e){e.preventDefault();e=a(this);t.openElement(e)}),t.modals={ELEMENT:null},t.templates={FORM:"mod_psgrading/reporting_modal_form"};var e=[];e.push(t.loadModal("ELEMENT","","Save",r.types.SAVE_CANCEL)),e.push(t.loadTemplate("EFFORT")),e.push(t.loadTemplate("TEXT")),a.when.apply(a,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},n.prototype.openElement=function(e){var t,o,a,n,r=this;r.modals.ELEMENT&&(t=e.data("type"),n=(o=e.closest(".reporting-row")).find(".student-info").html(),a=e.data("subjectarea"),e=e.data("grade"),n=n?n+": "+a:"Set "+a,r.modals.ELEMENT.setTitle(n),(n={})["is"+t]=!0,n["is"+e]=!0,console.log(n),s.render(r.templates.FORM,n).done(function(e){r.modals.ELEMENT.setBody(e)}),r.modals.ELEMENT.getRoot().on(l.save,function(e){var t=document.querySelector('input[name="effort"]:checked').value;i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({username:o.data("username"),subjectarea:a,grade:t})},done:function(){},fail:function(e){d.debug(e)}}])}),r.modals.ELEMENT.show())},n.prototype.loadModal=function(t,o,a,e){var n=this;return r.create({type:e}).then(function(e){e.setTitle(o),a&&e.setSaveButtonText(a),(n.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},n.prototype.loadTemplate=function(e){return s.render(this.templates[e],{})},{init:function(e,t){d.debug("mod_psgrading/reporting: initializing");var o=a(".psgrading-reporting");o.length?new n(o,e,t).main():d.error("mod_psgrading/reporting: .psgrading-reporting not found!")}}});