define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(n,s,d,e,t,i){"use strict";function a(e,t,o,r){var n=this;n.rootel=e,n.courseid=t,n.year=o,n.period=r}return a.prototype.main=function(){var t=this;n(window).click(function(){t.rootel.find("#reporting-grademenu").remove(),t.rootel.find(".report-element").removeClass("options-open")}),t.rootel.on("click",".report-element",function(e){e.preventDefault(),e.stopPropagation();e=n(this);e.hasClass("options-open")||t.openElement(e)}),t.rootel.on("click","#reporting-grademenu label",function(e){e.preventDefault(),e.stopPropagation();e=n(this);t.saveEffort(e)}),t.templates={FORM:"mod_psgrading/reporting_grademenu"};var e=[];e.push(t.loadTemplate("FORM")),n.when.apply(n,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},a.prototype.openElement=function(t){var o=this,e=t.data("type"),r=t.data("grade"),n=t.find(".options-area"),a={};a["is"+e]=!0,a["is"+r]=!0,i.render(o.templates.FORM,a).done(function(e){o.rootel.find("#reporting-grademenu").remove(),o.rootel.find(".report-element").removeClass("options-open"),t.addClass("options-open"),n.html(e)})},a.prototype.saveEffort=function(e){var t=this,o=e.data("value"),r=e.data("minimal"),n=e.closest(".report-element"),a=n.data("subjectarea"),i=n.data("type"),e=n.closest(".reporting-row");t.rootel.find("#reporting-grademenu").remove(),n.addClass("submitting"),d.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:t.courseid,year:t.year,period:t.period,username:e.data("username"),subjectarea:a,type:i,grade:o})},done:function(e){n.removeClass("submitting"),e&&(n.attr("data-grade",o),e=a,r&&(e+=" ("+r+")"),n.find(".subjectgrade").html(e))},fail:function(e){s.debug(e),n.removeClass("submitting")}}])},a.prototype.loadTemplate=function(e){return i.render(this.templates[e],{})},{init:function(e,t,o){s.debug("mod_psgrading/reporting: initializing");var r=n(".psgrading-reporting");r.length?new a(r,e,t,o).main():s.error("mod_psgrading/reporting: .psgrading-reporting not found!")}}});