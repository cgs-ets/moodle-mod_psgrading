define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(a,s,l,e,t,d){"use strict";function r(e,t,o,n){var a=this;a.rootel=e,a.courseid=t,a.year=o,a.period=n}return r.prototype.main=function(){var t=this;a(window).click(function(){"effort"==t.opentype&&t.closeElements()}),t.rootel.on("click",".report-element",function(e){e.preventDefault(),e.stopPropagation();e=a(this);e.hasClass("options-open")||t.openElement(e)}),t.rootel.on("click","#reporting-grademenu label",function(e){e.preventDefault(),e.stopPropagation();e=a(this);t.saveEffort(e)}),t.rootel.on("click","#reporting-grademenu .save",function(e){e.preventDefault(),e.stopPropagation();e=a(this);t.saveText(e)}),t.rootel.on("click","#reporting-grademenu .cancel",function(e){e.preventDefault(),e.stopPropagation(),t.closeElements()}),t.templates={FORM:"mod_psgrading/reporting_grademenu"};var e=[];e.push(t.loadTemplate("FORM")),a.when.apply(a,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},r.prototype.openElement=function(t){var o=this,e=t.data("type");o.opentype=e;var n=t.data("grade"),a=t.find(".options-area"),r=t.find(".element-reflection"),i={};i["is"+e]=!0,i["is"+n]=!0,i.reflection=r.val(),d.render(o.templates.FORM,i).done(function(e){o.closeElements(),t.addClass("options-open"),a.html(e)})},r.prototype.closeElements=function(){this.rootel.find("#reporting-grademenu").remove(),this.rootel.find(".report-element").removeClass("options-open")},r.prototype.saveEffort=function(e){var t=this,o=e.data("value"),n=e.data("minimal"),a=e.closest(".report-element"),r=a.data("subjectarea"),i=a.data("type"),e=a.closest(".reporting-row");t.closeElements(),a.addClass("submitting"),l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:t.courseid,year:t.year,period:t.period,username:e.data("username"),subjectarea:r,type:i,grade:o})},done:function(e){a.removeClass("submitting"),e&&(a.attr("data-grade",o),e=r,n&&(e+=" ("+n+")"),a.find(".subjectgrade").html(e))},fail:function(e){s.debug(e),a.removeClass("submitting")}}])},r.prototype.saveText=function(e){var t=this,o=e.closest(".report-element"),n=o.find(".element-reflection"),a=o.find(".element-text").val(),r=o.data("subjectarea"),i=o.data("type"),e=o.closest(".reporting-row");t.closeElements(),o.addClass("submitting"),l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:t.courseid,year:t.year,period:t.period,username:e.data("username"),subjectarea:r,type:i,reflection:a})},done:function(e){o.removeClass("submitting"),e&&a.length?(o.attr("data-grade","text_graded"),n.val(a)):o.attr("data-grade","")},fail:function(e){s.debug(e),o.removeClass("submitting")}}])},r.prototype.loadTemplate=function(e){return d.render(this.templates[e],{})},{init:function(e,t,o){s.debug("mod_psgrading/reporting: initializing");var n=a(".psgrading-reporting");n.length?new r(n,e,t,o).main():s.error("mod_psgrading/reporting: .psgrading-reporting not found!")}}});