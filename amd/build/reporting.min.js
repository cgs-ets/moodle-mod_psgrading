define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(n,l,p,e,t,d){"use strict";function r(e,t,o,a){var n=this;n.rootel=e,n.courseid=t,n.year=o,n.period=a,n.rootelinner=n.rootel.find(".psgrading-reporting"),n.editable=n.rootelinner.hasClass("editable")}return r.prototype.main=function(){var e,t=this;t.editable&&(n(window).click(function(){"effort"==t.opentype&&t.closeElements()}),t.rootel.on("click",'.report-element[data-type="effort"]',function(e){e.preventDefault(),e.stopPropagation();e=n(this);e.hasClass("options-open")||t.openInline(e)}),t.rootel.on("click",'.report-element[data-type="text"]',function(e){e.preventDefault(),e.stopPropagation();e=n(this);e.hasClass("options-open")||t.openPopout(e)}),t.rootel.on("click",".open-popout",function(e){e.preventDefault(),e.stopPropagation();e=n(this).closest(".report-element");t.openPopout(e)}),t.rootel.on("click",".options-area label",function(e){e.preventDefault(),e.stopPropagation();e=n(this);t.saveEffort(e)}),t.rootel.on("click",".options-area .save",function(e){e.preventDefault(),e.stopPropagation();e=n(this);t.saveText(e)}),t.rootel.on("click",".options-area .cancel",function(e){e.preventDefault(),e.stopPropagation(),t.closeElements()}),t.templates={INLINE:"mod_psgrading/reporting_inlinegrading",POPOUT:"mod_psgrading/reporting_popoutgrading"},(e=[]).push(t.loadTemplate("INLINE")),e.push(t.loadTemplate("POPOUT")),n.when.apply(n,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})),t.rootel.on("change",".reportingperiod-select",function(e){var t=n(this).find(":selected").data("viewurl");t&&window.location.replace(t)})},r.prototype.openInline=function(t){var o=this,a=t.closest(".reporting-row"),e=t.data("type");o.opentype=e;var n=t.data("grade"),r=t.find(".options-area"),i=t.find(".element-reflection"),s={};s["is"+e]=!0,s["is"+n]=!0,s.reflection=i.val(),d.render(o.templates.INLINE,s).done(function(e){o.closeElements(),a.addClass("dropdown-focussed"),t.addClass("options-open"),r.html(e)})},r.prototype.openPopout=function(t){var o=this,a=t.closest(".reporting-row"),n=t.data("type");o.opentype=n;var e=t.data("grade"),r=t.find(".options-area"),i=t.find(".element-reflection"),s={};s["is"+n]=!0,s["is"+e]=!0,s.reflection=i.val(),d.render(o.templates.POPOUT,s).done(function(e){o.closeElements(),a.addClass("popout-focussed"),t.addClass("options-open"),t.addClass("popout"),r.html(e),"text"==n&&p.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reporting_help",data:JSON.stringify({courseid:o.courseid,year:o.year,period:o.period,username:a.data("username"),subjectarea:t.data("subjectarea")})},done:function(e){e.length?r.find(".help-area").html(e):r.find(".help-area").html("No relevant task engagement data found for this subject.")},fail:function(e){l.debug(e),r.find(".help-area").html("No relevant task engagement data found for this subject.")}}])})},r.prototype.closeElements=function(){var e=this;e.rootel.find("#reporting-inlinegrading").remove(),e.rootel.find(".report-element").removeClass("options-open"),e.rootel.find(".report-element").removeClass("popout"),e.rootel.find(".reporting-row").removeClass("dropdown-focussed"),e.rootel.find(".reporting-row").removeClass("popout-focussed")},r.prototype.saveEffort=function(e){var t=e.data("value"),o=e.data("minimal"),a=e.closest(".report-element"),n=a.data("subjectarea"),r=a.data("type"),e=a.closest(".reporting-row");this.closeElements(),a.addClass("submitting"),p.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:this.courseid,year:this.year,period:this.period,username:e.data("username"),subjectarea:n,type:r,grade:t})},done:function(e){a.removeClass("submitting"),e&&(a.attr("data-grade",t),a.data("grade",t),e=n,o&&(e+=" ("+o+")"),a.find(".subjectgrade").html(e))},fail:function(e){l.debug(e),a.removeClass("submitting")}}])},r.prototype.saveText=function(e){var t=e.closest(".report-element"),o=t.find(".element-reflection"),a=t.find(".element-text").val(),n=t.data("subjectarea"),r=t.data("type"),e=t.closest(".reporting-row");this.closeElements(),t.addClass("submitting"),p.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:this.courseid,year:this.year,period:this.period,username:e.data("username"),subjectarea:n,type:r,reflection:a})},done:function(e){t.removeClass("submitting"),e&&a.length?t.attr("data-grade","text_graded"):t.attr("data-grade",""),o.val(a)},fail:function(e){l.debug(e),t.removeClass("submitting")}}])},r.prototype.loadTemplate=function(e){return d.render(this.templates[e],{})},{init:function(e,t,o){l.debug("mod_psgrading/reporting: initializing");var a=n("#page-mod-psgrading-reporting");a.length?new r(a,e,t,o).main():l.error("mod_psgrading/reporting: #page-mod-psgrading-reporting not found!")}}});