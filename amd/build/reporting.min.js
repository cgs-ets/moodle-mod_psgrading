define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/templates"],function(a,l,d,e,t,p){"use strict";function r(e,t,o,n){var a=this;a.rootel=e,a.courseid=t,a.year=o,a.period=n,a.rootelinner=a.rootel.find(".psgrading-reporting"),a.editable=a.rootelinner.hasClass("editable")}return r.prototype.main=function(){var e,t=this;t.editable&&(a(window).click(function(){"effort"==t.opentype&&t.closeElements()}),t.rootel.on("click",'.report-element[data-type="effort"]',function(e){e.preventDefault(),e.stopPropagation();e=a(this);e.hasClass("options-open")||t.openInline(e)}),t.rootel.on("click",'.report-element[data-type="text"]',function(e){e.preventDefault(),e.stopPropagation();e=a(this);e.hasClass("options-open")||t.openPopout(e)}),t.rootel.on("click",".open-popout",function(e){e.preventDefault(),e.stopPropagation();e=a(this).closest(".report-element");t.openPopout(e)}),t.rootel.on("click",".options-area label",function(e){e.preventDefault(),e.stopPropagation();e=a(this);t.saveEffort(e)}),t.rootel.on("click",".options-area .save",function(e){e.preventDefault(),e.stopPropagation();e=a(this);t.saveText(e)}),t.rootel.on("click",".options-area .cancel",function(e){e.preventDefault(),e.stopPropagation(),t.closeElements()}),t.rootel.on("change",".group-select",function(e){var t=a(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),t.templates={INLINE:"mod_psgrading/reporting_inlinegrading",POPOUT:"mod_psgrading/reporting_popoutgrading"},(e=[]).push(t.loadTemplate("INLINE")),e.push(t.loadTemplate("POPOUT")),a.when.apply(a,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})),t.rootel.on("change",".reportingperiod-select",function(e){var t=a(this).find(":selected").data("viewurl");t&&window.location.replace(t)})},r.prototype.openInline=function(t){var o=this,n=t.closest(".reporting-row"),e=t.data("type");o.opentype=e;var a=t.data("grade"),r=t.find(".options-area"),i=t.find(".element-reflection"),s={};s["is"+e]=!0,s["is"+a]=!0,s.reflection=i.val(),p.render(o.templates.INLINE,s).done(function(e){o.closeElements(),n.addClass("dropdown-focussed"),t.addClass("options-open"),r.html(e)})},r.prototype.openPopout=function(t){var o=this,n=t.closest(".reporting-row"),a=t.data("type");o.opentype=a;var e=t.data("grade"),r=t.find(".options-area"),i=t.find(".element-reflection"),s={};s["is"+a]=!0,s["is"+e]=!0,s.reflection=i.val(),p.render(o.templates.POPOUT,s).done(function(e){o.closeElements(),n.addClass("popout-focussed"),t.addClass("options-open"),t.addClass("popout"),r.html(e),"effort"==a&&d.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reporting_help",data:JSON.stringify({courseid:o.courseid,year:o.year,period:o.period,username:n.data("username"),subjectarea:t.data("subjectarea")})},done:function(e){e.length?r.find(".help-area").html(e):r.find(".help-area").html("No relevant task engagement data found for this subject.")},fail:function(e){l.debug(e),r.find(".help-area").html("No relevant task engagement data found for this subject.")}}])})},r.prototype.closeElements=function(){var e=this;e.rootel.find("#reporting-inlinegrading").remove(),e.rootel.find(".report-element").removeClass("options-open"),e.rootel.find(".report-element").removeClass("popout"),e.rootel.find(".reporting-row").removeClass("dropdown-focussed"),e.rootel.find(".reporting-row").removeClass("popout-focussed")},r.prototype.saveEffort=function(e){var t=e.data("value"),o=e.data("minimal"),n=e.closest(".report-element"),a=n.data("subjectarea"),r=n.data("type"),e=n.closest(".reporting-row");this.closeElements(),n.addClass("submitting"),d.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:this.courseid,year:this.year,period:this.period,username:e.data("username"),subjectarea:a,type:r,grade:t})},done:function(e){n.removeClass("submitting"),e&&(n.attr("data-grade",t),n.data("grade",t),e=a,o&&(e+=" ("+o+")"),n.find(".subjectgrade").html(e))},fail:function(e){l.debug(e),n.removeClass("submitting")}}])},r.prototype.saveText=function(e){var t=e.closest(".report-element"),o=t.find(".element-reflection"),n=t.find(".element-text").val(),a=t.data("subjectarea"),r=t.data("type"),e=t.closest(".reporting-row");this.closeElements(),t.addClass("submitting"),d.call([{methodname:"mod_psgrading_apicontrol",args:{action:"grade_element",data:JSON.stringify({courseid:this.courseid,year:this.year,period:this.period,username:e.data("username"),subjectarea:a,type:r,reflection:n})},done:function(e){t.removeClass("submitting"),e&&n.length?t.attr("data-grade","text_graded"):t.attr("data-grade",""),o.val(n)},fail:function(e){l.debug(e),t.removeClass("submitting")}}])},r.prototype.loadTemplate=function(e){return p.render(this.templates[e],{})},{init:function(e,t,o){l.debug("mod_psgrading/reporting: initializing");var n=a("#page-mod-psgrading-reporting");n.length?new r(n,e,t,o).main():l.error("mod_psgrading/reporting: #page-mod-psgrading-reporting not found!")}}});