define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(t,a,o,i,n){"use strict";function l(n){this.rootel=n}return l.prototype.main=function(){var n,e=this;setTimeout(function(){new l("sort-list");a.debug("list js initialised.")},6e3),e.checkCountdowns(),e.rootel.on("change",".group-select",function(n){var e=t(this).find(":selected").data("viewurl");e&&window.location.replace(e)}),e.rootel.on("click",".action-release",function(n){n.preventDefault();n=t(this);e.releaseTask(n)}),e.rootel.on("click",".action-publish",function(n){n.preventDefault();n=t(this);e.publishTask(n)}),e.rootel.on("click",".action-unpublish",function(n){n.preventDefault();n=t(this);e.unpublishTask(n)}),e.rootel.on("click",".action-undorelease",function(n){n.preventDefault();n=t(this);e.unreleaseTask(n)}),e.rootel.on("click",".action-delete",function(n){n.preventDefault();n=t(this);e.deleteTask(n)}),"undefined"!=typeof Sortable&&(n=document.getElementById("task-list"),new Sortable(n,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:e.SortEnd})),setInterval(function(){e.checkCountdowns()},9e3),e.modals={DIFF:null};t.when.apply(t,[]).then(function(){e.rootel.removeClass("preloading").addClass("preloads-completed")})},l.prototype.deleteTask=function(n){var e=n.closest(".col-taskname");n.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}])},l.prototype.publishTask=function(n){var e=n.closest(".col-taskname");n.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}])},l.prototype.unpublishTask=function(n){var e=n.closest(".col-taskname");n.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}])},l.prototype.releaseTask=function(n){var e=n.closest(".col-taskname");n.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}])},l.prototype.unreleaseTask=function(n){var e=n.closest(".col-taskname");n.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}])},l.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var e=t(this),n=e.closest(".col-taskname");o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:n.data("id")},done:function(n){a.debug(n),n?e.attr("data-original-title",n):window.location.reload(!1)},fail:function(n){a.debug(n)}}])})},l.prototype.SortEnd=function(n){var e;n.oldIndex!=n.newIndex&&(t(n.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t(".classlist-table").addClass("reordering"),e=new Array,t("#task-list .col-taskname").each(function(){e.push(t(this).data("id"))}),o.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(e)},done:function(){window.location.reload(!1)},fail:function(n){a.debug(n)}}]))},l.prototype.loadModal=function(e,t,a,n){var o=this;return i.create({type:n}).then(function(n){n.setTitle(t),a&&n.setSaveButtonText(a),(o.modals[e]=n).getBackdrop(),n.getRoot().addClass("modal-"+e)})},{init:function(){a.debug("mod_psgrading/list: initializing");var n=t("#page-mod-psgrading-view");n.length?new l(n).main():a.error("mod_psgrading/list: #page-mod-psgrading-view not found!")}}});