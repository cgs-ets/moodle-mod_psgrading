define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(a,o,n,d,i){"use strict";function e(t){this.rootel=t}return e.prototype.main=function(){var e=this;e.rootel.on("click",".action-release",function(t){t.preventDefault();t=a(this);e.releaseTask(t)}),e.rootel.on("click",".action-undorelease",function(t){t.preventDefault();t=a(this);e.unreleaseTask(t)}),e.rootel.on("click",".action-discarddraft",function(t){t.preventDefault();t=a(this);e.showDeleteDraft(t)}),"undefined"!=typeof Sortable&&(t=document.getElementById("task-list"),new Sortable(t,{handle:".btn-reorder",animation:150,ghostClass:"reordering",onEnd:e.SortEnd})),e.modals={DIFF:null};var t=[];t.push(e.loadModal("DIFF","Review draft changes and confirm deletion","Delete draft",d.types.SAVE_CANCEL)),a.when.apply(a,t).then(function(){e.rootel.removeClass("preloading").addClass("preloads-completed")})},e.prototype.showDeleteDraft=function(t){var e=this;e.modals.DIFF&&((t=t.closest(".task")).hasClass("not-published")?e.deleteDraft(t.data("id")):(n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_diff",data:t.data("id")},done:function(t){e.modals.DIFF.setBody(t)},fail:function(t){return o.debug(t),"Failed to load diff."}}]),e.modals.DIFF.getModal().addClass("modal-xl"),e.modals.DIFF.getRoot().on(i.save,{self:e,taskid:t.data("id")},e.handleDeleteDraft),e.modals.DIFF.show()))},e.prototype.handleDeleteDraft=function(t){var e=t.data.self,t=t.data.taskid;e.deleteDraft(t)},e.prototype.deleteDraft=function(t){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_draft",data:t},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},e.prototype.releaseTask=function(t){t=t.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},e.prototype.unreleaseTask=function(t){t=t.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},e.prototype.SortEnd=function(t){var e=new Array;a("#task-list .task").each(function(){e.push(a(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(e)},done:function(){},fail:function(t){o.debug(t)}}])},e.prototype.loadModal=function(e,a,o,t){var n=this;return d.create({type:t}).then(function(t){t.setTitle(a),o&&t.setSaveButtonText(o),(n.modals[e]=t).getBackdrop(),t.getRoot().addClass("modal-"+e)})},{init:function(){o.debug("mod_psgrading/list: initializing");var t=a("#page-mod-psgrading-view");t.length?new e(t).main():o.error("mod_psgrading/list: #page-mod-psgrading-view not found!")}}});