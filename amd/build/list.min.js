define(["jquery","core/log","core/config","core/ajax","core/templates","core/str","core/modal_factory","core/modal_events","local_myconnect/recipientselector"],function(s,d,e,c,r,t,a,o,n){"use strict";function l(e){var t=this;t.rootel=e,t.component="local_myconnect",t.overlay=s("#myconnect-overlay"),t.templates={SLIDER:"local_myconnect/slider",EXPORTRESULT:"local_myconnect/export_result"},t.modals={EXPORTRESULT:null}}return l.prototype.main=function(){var t=this;t.rootel.on("click",".display-options a",function(e){e.preventDefault();e=s(this);t.display(e)}),t.rootel.on("click",".recipient-result",function(e){e.preventDefault();e=s(this);window.location.href=e.data("timelineurl")}),t.rootel.on("click",".link-reply",function(e){e.preventDefault();e=s(this);t.expandReply(e)}),t.rootel.on("click",".link-post-reply",function(e){e.preventDefault();e=s(this);t.postReply(e)}),t.rootel.on("click",".link-post-cancel",function(e){e.preventDefault();e=s(this);t.cancelReply(e)}),t.rootel.on("click",".thread-reply",function(e){e.preventDefault();e=s(this).closest(".reply");e.addClass("replying"),e.find(".reply-comment").focus()}),t.rootel.on("click",".post-thread-reply",function(e){e.preventDefault();e=s(this);t.postThreadReply(e)}),t.rootel.on("click",".slide-trigger",function(e){e.preventDefault();e=s(this);t.displaySlide(e)}),t.rootel.on("click",".slider .nav",function(e){e.preventDefault(),e.stopPropagation();e=s(this);t.navSlider(e)}),t.rootel.on("click",".slider",function(e){e.preventDefault();e=s(this);t.closeSlider(e)}),t.rootel.on("click",".delete-post",function(e){e.preventDefault();e=s(this);t.delete(e)}),t.rootel.on("click",".delete-reply",function(e){e.preventDefault();e=s(this);t.deleteReply(e)}),t.rootel.on("click",".expand-recipients",function(e){e.preventDefault();e=s(this);t.expandRecipients(e)}),t.rootel.on("click",".reply-to-selector",function(e){e.preventDefault();e=s(this);t.showReplyToRecipients(e)}),t.rootel.on("click",".reply-to-recipient",function(e){e.preventDefault();e=s(this);t.changeReplyToRecipient(e)}),t.rootel.on("click",".conversation",function(e){e.preventDefault();e=s(this);t.showConversation(e)}),t.rootel.on("click",".btn-export",function(e){e.preventDefault(),t.export()}),s(".path-local-myconnect").on("click",".download-export-link ",function(e){t.modals.EXPORTRESULT.getModal(),t.modals.EXPORTRESULT.hide()}),"undefined"!=typeof InfiniteScroll&&new InfiniteScroll(".local_myconnect .list",{path:".next",append:".post",history:!1,status:".page-load-status"}),n.init(),t.rootel.removeClass("loadingjs");var e=[];e.push(t.loadModal("EXPORTRESULT","Export to zip","",a.types.DEFAULT)),s.when.apply(s,e).then(function(){t.rootel.addClass("preloads-completed")})},l.prototype.display=function(e){e=e.data("option");this.rootel.removeClass(function(e,t){return(t.match(/(^|\s)display-\S+/g)||[]).join(" ")}).addClass(e)},l.prototype.postReply=function(e){var t,o,n=this,l=e.closest(".post"),a=l.find(".reply-comment");0!=a.val().trim().length&&(t=l.data("id"),0!=(o=l.data("postsusersid"))||(e=l.find(".reply-to-selected")).length&&(o=e.attr("data-replyto")),l.removeClass("replying"),l.addClass("submitting-reply"),c.call([{methodname:"local_myconnect_post_reply",args:{postid:t,postsusersid:o,comment:a.val()},done:function(e){l.removeClass("submitting-reply"),a.val(""),n.loadReplies(t,o,e)},fail:function(e){l.removeClass("submitting-reply"),d.error("local_myconnect/list: failed to post a reply."),d.debug(e)}}]))},l.prototype.cancelReply=function(e){var t=e.closest(".post"),o=t.find(".reply-comment"),e=t.find(".reply-to-dropdown");t.removeClass("replying"),o.val(""),e.hide()},l.prototype.postThreadReply=function(e){var t=this,o=e.closest(".post"),n=o.data("id"),e=e.closest(".reply"),l=o.data("postsusersid"),a=e.find(".reply-comment");0!=a.val().trim().length&&(e.removeClass("replying"),o.addClass("submitting-reply"),c.call([{methodname:"local_myconnect_post_thread_reply",args:{postid:n,postsusersid:l,replyid:e.data("id"),comment:a.val()},done:function(e){o.removeClass("submitting-reply"),a.val(""),t.loadReplies(n,l,e)},fail:function(e){o.removeClass("submitting-reply"),d.error("local_myconnect/list: failed to post a thread reply."),d.debug(e)}}]))},l.prototype.loadReplies=function(n,l,a){var i,s=this,r=s.rootel.find('.post[data-id="'+n+'"]').first();r.length?(i=r.find(".post-replies"),r.addClass("loading-replies"),c.call([{methodname:"local_myconnect_load_replies",args:{postid:n,postsusersid:l,timelineuser:s.rootel.data("timelineuser")},done:function(e){i.replaceWith(e.html).hide();var t,o=r.find('.reply[data-id="'+a+'"]').first();r.hasClass("has-multiple")?(t=o.attr("data-conversationusername"),(e=r.find('.conversation[data-conversationusername="'+t+'"]').first()).length?(e.click(),r.removeClass("loading-replies"),o.addClass("just-created")):c.call([{methodname:"local_myconnect_load_conversations",args:{postid:n,timelineuser:s.rootel.data("timelineuser")},done:function(e){r.find(".conversations").first().replaceWith(e.html),r.find('.conversation[data-conversationusername="'+t+'"]').first().click(),r.removeClass("loading-replies"),o.addClass("just-created")},fail:function(e){r.removeClass("loading-replies"),d.error("local_myconnect/list: failed to load replies for post id: "+n+", postsusersid: "+l),d.debug(e)}}])):(r.removeClass("loading-replies"),o.addClass("just-created"))},fail:function(e){r.removeClass("loading-replies"),d.error("local_myconnect/list: failed to load replies for post id: "+n+", postsusersid: "+l),d.debug(e)}}])):d.error("local_myconnect/list.loadReplies: element .post[data-id="+n+"] not found.")},l.prototype.displaySlide=function(o){var t=this;t.overlay.addClass("active loading");var n=o.closest(".post"),e=n.find(".slider");if(e.length)return(a=n.find(".slide")).each(function(e){var t=s(this);t.removeClass("current"),t.data("src")==o.attr("href")&&t.addClass("current")}),e.addClass("active"),void t.overlay.removeClass("loading");var l=o.attr("href"),a=[],e=n.find(".slide-trigger"),i=1;e.each(function(e){var t=s(this).attr("href"),o=t==l?!0:!1;a.push({id:i,src:t,iscurrent:o}),i++});e={count:e.length,slides:a};r.render(t.templates.SLIDER,e).done(function(e){n.append(e),t.overlay.removeClass("loading")}).fail(function(e){d.debug(e)})},l.prototype.closeSlider=function(e){e.removeClass("active"),this.overlay.removeClass("active")},l.prototype.navSlider=function(e){var t=e.closest(".slider"),o=e.data("nav"),e=t.find(".slide.current"),o=e.data("id")+o;o>t.data("count")&&(o=1),0==o&&(o=t.data("count"));o=t.find('.slide[data-id="'+o+'"]');o.length&&(e.removeClass("current"),o.addClass("current"))},l.prototype.approve=function(e){var t=e.closest(".post"),e=t.data("id");t.addClass("submitting"),c.call([{methodname:"local_myconnect_approve_post",args:{id:e},done:function(e){t.removeClass("submitting"),t.removeClass("unapproved")},fail:function(e){t.removeClass("submitting"),d.error("local_myconnect/list: failed to approve the post"),d.debug(e)}}])},l.prototype.delete=function(e){var t=e.closest(".post"),o=t.data("id");t.addClass("submitting"),c.call([{methodname:"local_myconnect_delete_post",args:{id:o},done:function(e){t.removeClass("submitting"),t.addClass("removing"),t.fadeOut(1e3,function(){t.remove()})},fail:function(e){t.removeClass("submitting"),d.error("local_myconnect/list: failed to delete the post "+o),d.debug(e)}}])},l.prototype.deleteReply=function(e){var o=this,n=e.closest(".reply"),t=n.data("id"),l=n.data("poststhreadsid"),a=n.data("depth");n.addClass("deleting"),c.call([{methodname:"local_myconnect_delete_reply",args:{id:t},done:function(e){var t;n.removeClass("deleting"),0==a?((t=o.rootel.find('.reply[data-poststhreadsid="'+l+'"]')).push(n),t.addClass("removing"),t.fadeOut(1e3,function(){n.remove()})):(n.addClass("removing"),n.fadeOut(1e3,function(){n.remove()}))},fail:function(e){n.removeClass("deleting"),d.error("local_myconnect/list: failed to delete the reply "+t),d.debug(e)}}])},l.prototype.expandReply=function(e){self=this;var t=e.closest(".post");t.addClass("replying"),t.find(".reply-comment").focus();e=t.find(".conversation.active").first();e.length&&t.find('.reply-to-recipient[data-option="'+e.data("postsusersid")+'"]').click()},l.prototype.expandRecipients=function(e){e.hide(),e.closest(".post").find(".recipients").addClass("expanded").removeClass("collapsed")},l.prototype.showReplyToRecipients=function(e){e.next().fadeIn(200)},l.prototype.changeReplyToRecipient=function(e){var t=e.closest(".reply-to-dropdown"),o=e.closest(".reply-to").find(".reply-to-selected");o.attr("data-replyto",e.data("option")),o.html(e.attr("title")),t.slideUp(200)},l.prototype.showConversation=function(e){var t=e.closest(".post"),o=e.data("conversationusername");t.find(".conversation").removeClass("active"),e.addClass("active"),t.find(".reply").hide();o=t.find('.reply[data-conversationusername="'+o+'"], .reply[data-toeveryone="1"]'),t=t.find();o.fadeIn(200),t.fadeIn(200),e.find(".replycount").html(o.length)},l.prototype.loadModal=function(t,o,n,e){var l=this;return a.create({type:e}).then(function(e){e.setTitle(o),n&&e.setSaveButtonText(n),(l.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},l.prototype.export=function(){var o=this;o.modals.EXPORTRESULT&&(o.overlay.addClass("active loading"),c.call([{methodname:"local_myconnect_export",args:{timeline:o.rootel.data("timelineuser")},done:function(e){if("failed"==e.code)return o.overlay.removeClass("active loading"),void d.error("local_myconnect/list: failed to export timeline: "+e.data);var t={};"existinginprogress"==e.code?t.existinginprogress=!0:"existingready"==e.code?(t.existingready=!0,t.downloadurl=e.data):"ready"==e.code&&(t.ready=!0,t.downloadurl=e.data),r.render(o.templates.EXPORTRESULT,t).done(function(e){o.modals.EXPORTRESULT.getModal(),o.modals.EXPORTRESULT.setBody(e),o.modals.EXPORTRESULT.show(),o.overlay.removeClass("active loading")})},fail:function(e){o.overlay.removeClass("active loading"),d.error("local_myconnect/list: failed to export timeline: "+o.rootel.data("timelineuser")),d.debug(e)}}]))},l.prototype.loadTemplate=function(e){return r.render(this.templates[e],{})},l.prototype.loadModal=function(t,o,n,e){var l=this;return a.create({type:e}).then(function(e){e.setTitle(o),n&&e.setSaveButtonText(n),(l.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},{init:function(e){d.debug("local_announcements/list: initializing");var t=s(e).first();t.length?new l(t).main():d.error("local_announcements/list: "+e+" element not found!")}}});