define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(a,o,n,d,i){"use strict";function t(e){this.rootel=e}return t.prototype.main=function(){var t=this;t.checkCountdowns(),t.rootel.on("change",".group-select",function(e){var t=a(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),t.rootel.on("click",".action-release",function(e){e.preventDefault();e=a(this);t.releaseTask(e)}),t.rootel.on("click",".action-undorelease",function(e){e.preventDefault();e=a(this);t.unreleaseTask(e)}),t.rootel.on("click",".action-delete",function(e){e.preventDefault();e=a(this);t.showDeleteDraft(e)}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-list"),new Sortable(e,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:t.SortEnd})),setInterval(function(){t.checkCountdowns()},9e3),t.modals={DIFF:null};var e=[];e.push(t.loadModal("DIFF","Review draft changes and confirm deletion","Delete draft",d.types.SAVE_CANCEL)),a.when.apply(a,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},t.prototype.showDeleteDraft=function(e){var t=this,e=e.closest(".col-taskname");!e.hasClass("not-published")&&e.hasClass("is-draft")?t.modals.DIFF&&(n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_diff",data:e.data("id")},done:function(e){t.modals.DIFF.setBody(e)},fail:function(e){return o.debug(e),"Failed to load diff."}}]),t.modals.DIFF.getModal().addClass("modal-xl"),t.modals.DIFF.getRoot().on(i.save,{self:t,taskid:e.data("id")},t.handleDeleteDraft),t.modals.DIFF.show()):t.deleteDraft(e.data("id"))},t.prototype.handleDeleteDraft=function(e){var t=e.data.self,e=e.data.taskid;t.deleteDraft(e)},t.prototype.deleteDraft=function(e){this.rootel.find('.col-taskname[data-id="'+e+'"] .action-discarddraft').replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_draft",data:e},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},t.prototype.releaseTask=function(e){e=e.closest(".col-taskname");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},t.prototype.unreleaseTask=function(e){e=e.closest(".col-taskname");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},t.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var t=a(this),e=t.closest(".col-taskname");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:e.data("id")},done:function(e){o.debug(e),e?t.attr("data-original-title",e):window.location.reload(!1)},fail:function(e){o.debug(e)}}])})},t.prototype.SortEnd=function(e){var t;e.oldIndex!=e.newIndex&&(a(e.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),a(".classlist-table").addClass("reordering"),t=new Array,a("#task-list .col-taskname").each(function(){t.push(a(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(t)},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}]))},t.prototype.loadModal=function(t,a,o,e){var n=this;return d.create({type:e}).then(function(e){e.setTitle(a),o&&e.setSaveButtonText(o),(n.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},{init:function(){o.debug("mod_psgrading/list: initializing");var e=a("#page-mod-psgrading-view");e.length?new t(e).main():o.error("mod_psgrading/list: #page-mod-psgrading-view not found!")}}});