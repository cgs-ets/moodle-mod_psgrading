define(["jquery","core/log","core/ajax"],function(o,r,e){"use strict";function i(e,t,n){var o=this;o.rootel=e,o.userid=t,o.taskid=n}return i.prototype.main=function(){var t=this;t.rootel.on("change",".student-select",function(e){var t=o(this).find(":selected").data("markurl");t&&window.location.replace(t)}),t.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=o(this);t.selectLevel(e)}),t.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,t.regenerateCriterionJSON(),t.rootel.find('[name="action"]').val("save"),t.rootel.submit()}),t.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,t.regenerateCriterionJSON(),t.rootel.find('[name="action"]').val("saveshownext"),t.rootel.submit()}),t.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,t.rootel.find('[name="action"]').val("reset"),t.rootel.submit()})},i.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},i.prototype.regenerateCriterionJSON=function(){var e=o('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=o(this),t=e.find(".level.selected").first().data("level");void 0===t&&(t=0);t={id:e.data("id"),selectedlevel:t};n.push(t)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},{init:function(e,t){r.debug("mod_psgrading/mark: initializing");var n=o('form[data-form="psgrading-mark"]');n.length?new i(n,e,t).main():r.error('mod_psgrading/mark: form[data-form="psgrading-mark"] not found!')}}});