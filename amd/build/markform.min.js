define(["jquery","core/log","core/ajax"],function(o,r,e){"use strict";function i(e,n,t){var o=this;o.rootel=e,o.userid=n,o.taskid=t}return i.prototype.main=function(){var n=this;n.rootel.on("change",".student-select",function(e){var n=o(this).find(":selected").data("markurl");n&&window.location.replace(n)}),n.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=o(this);n.selectLevel(e),window.onbeforeunload=function(){return"You have unsaved changes!"}}),n.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("save"),n.rootel.submit()}),n.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("saveshownext"),n.rootel.submit()}),n.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("reset"),n.rootel.submit()})},i.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},i.prototype.regenerateCriterionJSON=function(){var e=o('input[name="criterionjson"]'),t=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=o(this),n=e.find(".level.selected").first().data("level");void 0===n&&(n=0);n={id:e.data("id"),selectedlevel:n};t.push(n)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},{init:function(e,n){r.debug("mod_psgrading/mark: initializing");var t=o('form[data-form="psgrading-mark"]');t.length?new i(t,e,n).main():r.error('mod_psgrading/mark: form[data-form="psgrading-mark"] not found!')}}});