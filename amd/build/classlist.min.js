define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events","core/url"],function(a,n,i,l,s,t){"use strict";function o(e){this.rootel=e}return o.prototype.main=function(){var o=this;o.checkCountdowns(),o.rootel.on("change",".reportingperiod-select",function(e){var t=a(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),o.rootel.on("change",".group-select",function(e){var t=a(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),o.rootel.on("click",".action-release",function(e){e.preventDefault();var t=a(this);o.checkEvidenceVisibility(t).then(function(e){console.log("Evidence visibility status:",e),o.releaseTask(t,e)}).catch(function(e){console.log("Error checking evidence visibility:",e)})}),o.rootel.on("click",".action-publish",function(e){e.preventDefault();e=a(this);o.publishTask(e)}),o.rootel.on("click",".action-unpublish",function(e){e.preventDefault();e=a(this);o.unpublishTask(e)}),o.rootel.on("click",".action-undorelease",function(e){e.preventDefault();e=a(this);o.unreleaseTask(e)}),o.rootel.on("click",".action-delete",function(e){e.preventDefault();e=a(this);o.deleteTask(e)}),o.rootel.on("click",".btn-fullscreen",function(e){e.preventDefault();e=a(this);o.rootel.hasClass("zoomed")?(o.rootel.removeClass("zoomed"),e.html('<i class="fa fa-window-maximize" aria-hidden="true"></i>')):(o.rootel.addClass("zoomed"),e.html('<i class="fa fa-window-minimize" aria-hidden="true"></i>'))}),o.rootel.on("click",".btn-toggle",function(e){e.preventDefault();e=a(this);o.rootel.hasClass("toggleoff")?(o.rootel.removeClass("toggleoff"),e.html('<i class="fa fa-toggle-off" aria-hidden="true"></i>'),o.showHiddenTasks()):(o.rootel.addClass("toggleoff"),e.html('<i class="fa fa-toggle-on" aria-hidden="true"></i>'),o.hideHiddenTasks())}),o.rootel.on("click",".btn-recycle",function(e){e.preventDefault();e=window.location.search,e=new URLSearchParams(e);console.log(e.get("id"));e=e.get("id"),e=t.relativeUrl("/mod/psgrading/recyclebin.php",{id:e},!0);e&&window.location.replace(e)}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-list"),new Sortable(e,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",forceFallback:!0,onEnd:o.SortEnd}));new List("class-list",{valueNames:["col-firstname","col-lastname"]});setInterval(function(){o.checkCountdowns()},9e3),o.modals={DELETE:null,RELEASE:null};var e=[];e.push(o.loadModal("DELETE","Confirm delete","Delete",l.types.SAVE_CANCEL)),e.push(o.loadModal("RELEASE","Confirm release","Release",l.types.SAVE_CANCEL)),a.when.apply(a,e).then(function(){o.rootel.removeClass("preloading").addClass("preloads-completed")})},o.prototype.deleteTask=function(e){var t=this,o=e.closest(".col-taskname"),e=o.find(".text").first().html();t.modals.DELETE&&(t.modals.DELETE.setBody("<p>Are you sure you want to delete this task?<br><strong>"+e+"</strong></p>"),t.modals.DELETE.getRoot().on(s.save,function(e){i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:o.data("id")},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}])}),t.modals.DELETE.show())},o.prototype.publishTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}])},o.prototype.unpublishTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}])},o.prototype.releaseTask=function(e,t){var o=e.closest(".col-taskname"),a=o.find(".text").first().html(),e="<p>Are you sure you want to release this task?<br><strong>"+a+"</strong></p>";this.modals.RELEASE&&(0<t?e="<p>Are you sure you want to release this task?<br><strong>"+a+"</strong></p><p>One or more pieces of evidence that you selected for this task are hidden and will not be visible to parents.</p>":-1==t&&(e="<p>The PS grading activity is currently <strong>hidden</strong>. If you release the subject now, parents will not be able to see it. </p><p> Please make the PS grading activity visible before releasing the subject</p>"),this.modals.RELEASE.setBody(e),this.modals.RELEASE.getRoot().on(s.save,function(e){i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:o.data("id")},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}])}),this.modals.RELEASE.show())},o.prototype.unreleaseTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}])},o.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var t=a(this),e=t.closest(".col-taskname");i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:e.data("id")},done:function(e){n.debug(e),e?t.attr("data-original-title",e):window.location.reload(!1)},fail:function(e){n.debug(e)}}])})},o.prototype.SortEnd=function(e){var t;e.oldIndex!=e.newIndex&&(a(e.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),a(".classlist-table").addClass("reordering"),t=new Array,a("#task-list .col-taskname").each(function(){t.push(a(this).data("id"))}),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(t)},done:function(){window.location.reload(!1)},fail:function(e){n.debug(e)}}]))},o.prototype.loadModal=function(t,o,a,e){var n=this;return l.create({type:e}).then(function(e){e.setTitle(o),a&&e.setSaveButtonText(a),(n.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},o.prototype.hideHiddenTasks=function(){var t=new Map,o=new Map;document.querySelectorAll(".not-published").forEach(function(e){e.classList.add("toggleon");e=e.getAttribute("data-cmid");t.get(e)?t.set(e,t.get(e)+1):null!=e&&t.set(e,1),o.get(e)||null==e||o.set(e,document.querySelectorAll('.col-taskname[data-cmid="'+e+'"]').length)}),0<t.size&&0<o.size&&this.recalculateHeaderWidth(o,t,!0)},o.prototype.showHiddenTasks=function(){var t=new Map,o=new Map;document.querySelectorAll(".not-published").forEach(function(e){e.classList.remove("toggleon");e=e.getAttribute("data-cmid");t.get(e)?t.set(e,t.get(e)+1):null!=e&&t.set(e,1),o.get(e)||null==e||o.set(e,document.querySelectorAll('.col-taskname[data-cmid="'+e+'"]').length)}),0<t.size&&0<o.size&&this.recalculateHeaderWidth(o,t,!1)},o.prototype.recalculateHeaderWidth=function(n,i,l){document.querySelectorAll(".column.col-cm").forEach(function(e){var t=e.getAttribute("data-cmid"),o=void 0,a=n.get(t),t=i.get(t);null!=a&&null!=t&&(o=l?a-t:a),0==o?e.classList.add("toggleon"):e.classList.remove("toggleon"),null!=o&&(e.style.width="calc(90px * "+o+")")})},o.prototype.checkEvidenceVisibility=function(e){var a=e.closest(".col-taskname").data("id");return new Promise(function(t,o){i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"check_visibility",data:a},done:function(e){t(e)},fail:function(e){n.debug(e),o(e)}}])})},{init:function(){n.debug("mod_psgrading/classlist: initializing");var e=a(".psgrading-overview-page");e.length?new o(e).main():n.error("mod_psgrading/classlist: .psgrading-overview-page not found!")}}});