define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(o,a,n,i,l){"use strict";function t(e){this.rootel=e}return t.prototype.main=function(){var t=this;t.checkCountdowns(),t.rootel.on("change",".reportingperiod-select",function(e){var t=o(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),t.rootel.on("change",".group-select",function(e){var t=o(this).find(":selected").data("viewurl");t&&window.location.replace(t)}),t.rootel.on("click",".action-release",function(e){e.preventDefault();e=o(this);t.releaseTask(e)}),t.rootel.on("click",".action-publish",function(e){e.preventDefault();e=o(this);t.publishTask(e)}),t.rootel.on("click",".action-unpublish",function(e){e.preventDefault();e=o(this);t.unpublishTask(e)}),t.rootel.on("click",".action-undorelease",function(e){e.preventDefault();e=o(this);t.unreleaseTask(e)}),t.rootel.on("click",".action-delete",function(e){e.preventDefault();e=o(this);t.deleteTask(e)}),t.rootel.on("click",".btn-fullscreen",function(e){e.preventDefault();e=o(this);t.rootel.hasClass("zoomed")?(t.rootel.removeClass("zoomed"),e.html('<i class="fa fa-window-maximize" aria-hidden="true"></i>')):(t.rootel.addClass("zoomed"),e.html('<i class="fa fa-window-minimize" aria-hidden="true"></i>'))}),t.rootel.on("click",".btn-toggle",function(e){e.preventDefault();e=o(this);t.rootel.hasClass("toggleoff")?(t.rootel.removeClass("toggleoff"),e.html('<i class="fa fa-toggle-off" aria-hidden="true"></i>'),t.showHiddenTasks()):(t.rootel.addClass("toggleoff"),e.html('<i class="fa fa-toggle-on" aria-hidden="true"></i>'),t.hideHiddenTasks())}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-list"),new Sortable(e,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:t.SortEnd}));new List("class-list",{valueNames:["col-firstname","col-lastname"]});setInterval(function(){t.checkCountdowns()},9e3),t.modals={DELETE:null,RELEASE:null};var e=[];e.push(t.loadModal("DELETE","Confirm delete","Delete",i.types.SAVE_CANCEL)),e.push(t.loadModal("RELEASE","Confirm release","Release",i.types.SAVE_CANCEL)),o.when.apply(o,e).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},t.prototype.deleteTask=function(e){var t=this,o=e.closest(".col-taskname"),e=o.find(".text").first().html();t.modals.DELETE&&(t.modals.DELETE.setBody("<p>Are you sure you want to delete this task?<br><strong>"+e+"</strong></p>"),t.modals.DELETE.getRoot().on(l.save,function(e){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:o.data("id")},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}])}),t.modals.DELETE.show())},t.prototype.publishTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}])},t.prototype.unpublishTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}])},t.prototype.releaseTask=function(e){var t=this,o=e.closest(".col-taskname"),e=o.find(".text").first().html();t.modals.RELEASE&&(t.modals.RELEASE.setBody("<p>Are you sure you want to release this task?<br><strong>"+e+"</strong></p>"),t.modals.RELEASE.getRoot().on(l.save,function(e){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:o.data("id")},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}])}),t.modals.RELEASE.show())},t.prototype.unreleaseTask=function(e){var t=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}])},t.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var t=o(this),e=t.closest(".col-taskname");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:e.data("id")},done:function(e){a.debug(e),e?t.attr("data-original-title",e):window.location.reload(!1)},fail:function(e){a.debug(e)}}])})},t.prototype.SortEnd=function(e){var t;e.oldIndex!=e.newIndex&&(o(e.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),o(".classlist-table").addClass("reordering"),t=new Array,o("#task-list .col-taskname").each(function(){t.push(o(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(t)},done:function(){window.location.reload(!1)},fail:function(e){a.debug(e)}}]))},t.prototype.loadModal=function(t,o,a,e){var n=this;return i.create({type:e}).then(function(e){e.setTitle(o),a&&e.setSaveButtonText(a),(n.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},t.prototype.hideHiddenTasks=function(){var t=new Map,o=new Map;document.querySelectorAll(".not-published").forEach(function(e){e.classList.add("toggleon");e=e.getAttribute("data-cmid");t.get(e)?t.set(e,t.get(e)+1):null!=e&&t.set(e,1),o.get(e)||null==e||o.set(e,document.querySelectorAll('.col-taskname[data-cmid="'+e+'"]').length)}),this.recalculateHeaderWidth(o,t,!0)},t.prototype.showHiddenTasks=function(){var t=new Map,o=new Map;document.querySelectorAll(".not-published").forEach(function(e){e.classList.remove("toggleon");e=e.getAttribute("data-cmid");t.get(e)?t.set(e,t.get(e)+1):null!=e&&t.set(e,1),o.get(e)||null==e||o.set(e,document.querySelectorAll('.col-taskname[data-cmid="'+e+'"]').length)}),this.recalculateHeaderWidth(o,t,!1)},t.prototype.recalculateHeaderWidth=function(a,n,i){document.querySelectorAll(".column.col-cm").forEach(function(e){var t=e.getAttribute("data-cmid"),o=0;0==(o=i?a.get(t)-n.get(t):a.get(t))?e.classList.add("toggleon"):e.classList.remove("toggleon"),e.style.width="calc(90px * "+o+")"})},{init:function(){a.debug("mod_psgrading/classlist: initializing");var e=o(".psgrading-overview-page");e.length?new t(e).main():a.error("mod_psgrading/classlist: .psgrading-overview-page not found!")}}});