define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(t,a,n,i,s){"use strict";function e(o){this.rootel=o}return e.prototype.main=function(){var e=this;e.checkCountdowns(),e.rootel.on("change",".group-select",function(o){var e=t(this).find(":selected").data("viewurl");e&&window.location.replace(e)}),e.rootel.on("click",".action-release",function(o){o.preventDefault();o=t(this);e.releaseTask(o)}),e.rootel.on("click",".action-publish",function(o){o.preventDefault();o=t(this);e.publishTask(o)}),e.rootel.on("click",".action-unpublish",function(o){o.preventDefault();o=t(this);e.unpublishTask(o)}),e.rootel.on("click",".action-undorelease",function(o){o.preventDefault();o=t(this);e.unreleaseTask(o)}),e.rootel.on("click",".action-delete",function(o){o.preventDefault();o=t(this);e.deleteTask(o)}),e.rootel.on("click",".btn-fullscreen",function(o){o.preventDefault();o=t(this);e.rootel.hasClass("zoomed")?(e.rootel.removeClass("zoomed"),o.html('<i class="fa fa-window-maximize" aria-hidden="true"></i>')):(e.rootel.addClass("zoomed"),o.html('<i class="fa fa-window-minimize" aria-hidden="true"></i>'))}),"undefined"!=typeof Sortable&&(o=document.getElementById("task-list"),new Sortable(o,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:e.SortEnd}));new List("class-list",{valueNames:["col-firstname","col-lastname"]});setInterval(function(){e.checkCountdowns()},9e3),e.modals={DELETE:null,RELEASE:null};var o=[];o.push(e.loadModal("DELETE","Confirm delete","Delete",i.types.SAVE_CANCEL)),o.push(e.loadModal("RELEASE","Confirm release","Release",i.types.SAVE_CANCEL)),t.when.apply(t,o).then(function(){e.rootel.removeClass("preloading").addClass("preloads-completed")})},e.prototype.deleteTask=function(o){var e=this,t=o.closest(".col-taskname"),o=t.find(".text").first().html();e.modals.DELETE&&(e.modals.DELETE.setBody("<p>Are you sure you want to delete this task?<br><strong>"+o+"</strong></p>"),e.modals.DELETE.getRoot().on(s.save,function(o){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}])}),e.modals.DELETE.show())},e.prototype.publishTask=function(o){var e=o.closest(".col-taskname");o.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}])},e.prototype.unpublishTask=function(o){var e=o.closest(".col-taskname");o.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}])},e.prototype.releaseTask=function(o){var e=this,t=o.closest(".col-taskname"),o=t.find(".text").first().html();e.modals.RELEASE&&(e.modals.RELEASE.setBody("<p>Are you sure you want to release this task?<br><strong>"+o+"</strong></p>"),e.modals.RELEASE.getRoot().on(s.save,function(o){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}])}),e.modals.RELEASE.show())},e.prototype.unreleaseTask=function(o){var e=o.closest(".col-taskname");o.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:e.data("id")},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}])},e.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var e=t(this),o=e.closest(".col-taskname");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:o.data("id")},done:function(o){a.debug(o),o?e.attr("data-original-title",o):window.location.reload(!1)},fail:function(o){a.debug(o)}}])})},e.prototype.SortEnd=function(o){var e;o.oldIndex!=o.newIndex&&(t(o.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t(".classlist-table").addClass("reordering"),e=new Array,t("#task-list .col-taskname").each(function(){e.push(t(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(e)},done:function(){window.location.reload(!1)},fail:function(o){a.debug(o)}}]))},e.prototype.loadModal=function(e,t,a,o){var n=this;return i.create({type:o}).then(function(o){o.setTitle(t),a&&o.setSaveButtonText(a),(n.modals[e]=o).getBackdrop(),o.getRoot().addClass("modal-"+e)})},{init:function(){a.debug("mod_psgrading/classlist: initializing");var o=t(".psgrading-overview-page");o.length?new e(o).main():a.error("mod_psgrading/classlist: .psgrading-overview-page not found!")}}});