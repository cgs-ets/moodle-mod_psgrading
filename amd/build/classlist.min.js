define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(e,o,t,i,a){"use strict";function n(a){this.rootel=a}return n.prototype.main=function(){var a,n=this;n.checkCountdowns(),n.rootel.on("change",".group-select",function(a){var n=e(this).find(":selected").data("viewurl");n&&window.location.replace(n)}),n.rootel.on("click",".action-release",function(a){a.preventDefault();a=e(this);n.releaseTask(a)}),n.rootel.on("click",".action-publish",function(a){a.preventDefault();a=e(this);n.publishTask(a)}),n.rootel.on("click",".action-unpublish",function(a){a.preventDefault();a=e(this);n.unpublishTask(a)}),n.rootel.on("click",".action-undorelease",function(a){a.preventDefault();a=e(this);n.unreleaseTask(a)}),n.rootel.on("click",".action-delete",function(a){a.preventDefault();a=e(this);n.deleteTask(a)}),"undefined"!=typeof Sortable&&(a=document.getElementById("task-list"),new Sortable(a,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:n.SortEnd}));new List("class-list",{valueNames:["col-firstname","col-lastname"]});setInterval(function(){n.checkCountdowns()},9e3),n.modals={DIFF:null};e.when.apply(e,[]).then(function(){n.rootel.removeClass("preloading").addClass("preloads-completed")})},n.prototype.deleteTask=function(a){var n=a.closest(".col-taskname");a.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:n.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},n.prototype.publishTask=function(a){var n=a.closest(".col-taskname");a.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:n.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},n.prototype.unpublishTask=function(a){var n=a.closest(".col-taskname");a.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:n.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},n.prototype.releaseTask=function(a){var n=a.closest(".col-taskname");a.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:n.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},n.prototype.unreleaseTask=function(a){var n=a.closest(".col-taskname");a.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:n.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},n.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var n=e(this),a=n.closest(".col-taskname");t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:a.data("id")},done:function(a){o.debug(a),a?n.attr("data-original-title",a):window.location.reload(!1)},fail:function(a){o.debug(a)}}])})},n.prototype.SortEnd=function(a){var n;a.oldIndex!=a.newIndex&&(e(a.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),e(".classlist-table").addClass("reordering"),n=new Array,e("#task-list .col-taskname").each(function(){n.push(e(this).data("id"))}),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(n)},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}]))},n.prototype.loadModal=function(n,e,o,a){var t=this;return i.create({type:a}).then(function(a){a.setTitle(e),o&&a.setSaveButtonText(o),(t.modals[n]=a).getBackdrop(),a.getRoot().addClass("modal-"+n)})},{init:function(){o.debug("mod_psgrading/classlist: initializing");var a=e("#page-mod-psgrading-view");a.length?new n(a).main():o.error("mod_psgrading/classlist: #page-mod-psgrading-view not found!")}}});