define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(n,o,t,i,e){"use strict";function a(e){this.rootel=e}return a.prototype.main=function(){var e,a=this;a.checkCountdowns(),a.rootel.on("change",".group-select",function(e){var a=n(this).find(":selected").data("viewurl");a&&window.location.replace(a)}),a.rootel.on("click",".action-release",function(e){e.preventDefault();e=n(this);a.releaseTask(e)}),a.rootel.on("click",".action-publish",function(e){e.preventDefault();e=n(this);a.publishTask(e)}),a.rootel.on("click",".action-unpublish",function(e){e.preventDefault();e=n(this);a.unpublishTask(e)}),a.rootel.on("click",".action-undorelease",function(e){e.preventDefault();e=n(this);a.unreleaseTask(e)}),a.rootel.on("click",".action-delete",function(e){e.preventDefault();e=n(this);a.deleteTask(e)}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-list"),new Sortable(e,{draggable:".col-taskname",handle:".action-reorder",animation:150,ghostClass:"reordering",onEnd:a.SortEnd}));new List("class-list",{valueNames:["col-firstname","col-lastname"]});setInterval(function(){a.checkCountdowns()},9e3),a.modals={DIFF:null};n.when.apply(n,[]).then(function(){a.rootel.removeClass("preloading").addClass("preloads-completed")})},a.prototype.deleteTask=function(e){var a=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},a.prototype.publishTask=function(e){var a=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"publish_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},a.prototype.unpublishTask=function(e){var a=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unpublish_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},a.prototype.releaseTask=function(e){var a=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},a.prototype.unreleaseTask=function(e){var a=e.closest(".col-taskname");e.replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}])},a.prototype.checkCountdowns=function(){this.rootel.find(".action-undorelease").each(function(){var a=n(this),e=a.closest(".col-taskname");t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_countdown",data:e.data("id")},done:function(e){o.debug(e),e?a.attr("data-original-title",e):window.location.reload(!1)},fail:function(e){o.debug(e)}}])})},a.prototype.SortEnd=function(e){var a;e.oldIndex!=e.newIndex&&(n(e.item).find(".btn-reorder").replaceWith('<div class="spinner"><div class="circle spin"></div></div>'),n(".classlist-table").addClass("reordering"),a=new Array,n("#task-list .col-taskname").each(function(){a.push(n(this).data("id"))}),t.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(a)},done:function(){window.location.reload(!1)},fail:function(e){o.debug(e)}}]))},a.prototype.loadModal=function(a,n,o,e){var t=this;return i.create({type:e}).then(function(e){e.setTitle(n),o&&e.setSaveButtonText(o),(t.modals[a]=e).getBackdrop(),e.getRoot().addClass("modal-"+a)})},{init:function(){o.debug("mod_psgrading/classlist: initializing");var e=n(".psgrading-overview-page");e.length?new a(e).main():o.error("mod_psgrading/classlist: .psgrading-overview-page not found!")}}});