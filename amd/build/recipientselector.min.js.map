{"version":3,"sources":["../src/recipientselector.js"],"names":["define","$","Log","Ajax","Templates","Str","RecipientSelector","rootel","types","roles","allowmultiple","self","component","addClass","strings","get_strings","key","then","s","noselectionstr","prototype","main","render","keytimer","on","e","clearTimeout","autocomplete","which","search","setTimeout","preventDefault","tag","add","remove","refocus","document","target","is","unfocus","input","tags","val","JSON","parse","i","length","data","obj","taguid","Date","now","idfield","photourl","find","attr","fullname","first","text","type","push","json","stringify","removeuid","tagsnew","curruid","removeClass","html","pop","fail","reason","error","searchel","hasresults","call","methodname","args","query","done","response","users","results","debug","init","recipientselector"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n/**\r\n * Module for recipient autocomplete field.\r\n *\r\n * @package   mod_psgrading\r\n * @category  output\r\n * @copyright 2020 Michael Vangelovski\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\n/**\r\n * @module mod_psgrading/recipientselector\r\n */\r\ndefine(['jquery', 'core/log', 'core/ajax', 'core/templates', 'core/str'], function($, Log, Ajax, Templates, Str) {\r\n    'use strict';\r\n\r\n    /**\r\n     * Initializes the recipientselector component.\r\n     */\r\n    function init(types, roles, allowmultiple) {\r\n        Log.debug('mod_psgrading/recipientselector: initializing the recipient-selector component');\r\n\r\n        var rootel = $('.recipient-selector').first();\r\n\r\n        if (!rootel.length) {\r\n            Log.error('mod_psgrading/recipientselector: recipient-selector root element not found!');\r\n            return;\r\n        }\r\n\r\n        if (typeof types === 'undefined') {\r\n            types = ['user'];\r\n        }\r\n\r\n        if (typeof roles === 'undefined') {\r\n            roles = ['student'];\r\n        }\r\n\r\n        if (typeof allowmultiple === 'undefined') {\r\n            allowmultiple = true;\r\n        }\r\n\r\n        var recipientselector = new RecipientSelector(rootel, types, roles, allowmultiple);\r\n        recipientselector.main();\r\n\r\n        return recipientselector;\r\n    }\r\n\r\n    /**\r\n     * The recipient selector constructor\r\n     *\r\n     * @constructor\r\n     * @param {jQuery} rootel\r\n     */\r\n    function RecipientSelector(rootel, types, roles, allowmultiple) {\r\n        var self = this;\r\n        self.rootel = rootel;\r\n        self.component = 'mod_psgrading';\r\n        self.types = types;\r\n        self.roles = roles;\r\n        self.allowmultiple = allowmultiple;\r\n        if (self.allowmultiple) {\r\n            self.rootel.addClass('allow-multiple');\r\n        } else {\r\n            self.rootel.addClass('allow-single');\r\n        }\r\n\r\n        self.strings = {}\r\n        Str.get_strings([\r\n            {key: 'postform:recipientnoselection', component: self.component},\r\n        ]).then(function(s) {\r\n            self.strings.noselectionstr = s[0];\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Run the Recipient Selector.\r\n     *\r\n     */\r\n   RecipientSelector.prototype.main = function () {\r\n        var self = this;\r\n\r\n        // Render existing selection (if editing).\r\n        self.render();\r\n\r\n        // Handle search.\r\n        var keytimer;\r\n        self.rootel.on('keyup', '.recipient-autocomplete', function(e) {\r\n            clearTimeout(keytimer);\r\n            var autocomplete = $(this);\r\n            if (e.which == 13) {\r\n                self.search(autocomplete);\r\n            } else {\r\n                keytimer = setTimeout(function () {\r\n                    self.search(autocomplete);\r\n                }, 500);\r\n            }\r\n        });\r\n\r\n        // Handle search result click.\r\n        self.rootel.on('click', '.recipient-result', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.add(tag);\r\n        });\r\n\r\n        // Handle tag click.\r\n        self.rootel.on('click', '.recipient-tag', function(e) {\r\n            e.preventDefault();\r\n            var tag = $(this);\r\n            self.remove(tag);\r\n        });\r\n\r\n        // Handle entering the autocomplete field.\r\n        self.rootel.on('focus', '.recipient-autocomplete', function(e) {\r\n            self.refocus();\r\n        });\r\n\r\n        // Handle leaving the autocomplete field.\r\n        $(document).on('click', function (e) {\r\n            var target = $(e.target);\r\n            if (target.is('.recipient-autocomplete') || target.is('.recipient-result')) {\r\n                return;\r\n            }\r\n            self.unfocus();\r\n        });\r\n    };\r\n\r\n\r\n    /**\r\n     * Add a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.add = function (tag) {\r\n        var self = this;\r\n        self.unfocus();\r\n\r\n        self.rootel.addClass('adding-tag');\r\n\r\n        var input = $('input[name=\"recipientjson\"]');\r\n\r\n        // Convert JSON into array.\r\n        var tags = new Array();\r\n        if(input.val()) {\r\n            tags = JSON.parse(input.val());\r\n        }\r\n\r\n        // Ensure tag has not already been added.\r\n        var i;\r\n        for (i = 0; i < tags.length; i++) {\r\n            if (tags[i]['idfield'] == tag.data('idfield')) {\r\n                self.render();\r\n                return;\r\n            }\r\n        }\r\n\r\n        // Create a new tag object and add tag to array.\r\n        var obj = {\r\n            taguid: Date.now(),\r\n            idfield: tag.data('idfield'),\r\n            photourl: tag.find('img').attr('src'),\r\n            fullname: tag.find('span').first().text(),\r\n            type: tag.data('type'),\r\n        };\r\n        tags.push(obj);\r\n\r\n        // Encode to json and to hidden input.\r\n        var json = JSON.stringify(tags);\r\n        input.val(json);\r\n\r\n        self.render();\r\n    };\r\n\r\n    /**\r\n     * Remove a selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.remove = function (tag) {\r\n        var self = this;\r\n\r\n        var removeuid = tag.data('taguid');\r\n        var input = $('input[name=\"recipientjson\"]');\r\n        var tags = JSON.parse(input.val());\r\n        var tagsnew = new Array();\r\n        var i;\r\n        for (i = 0; i < tags.length; i++) {\r\n            var curruid = tags[i]['taguid'];\r\n            if (curruid != removeuid) {\r\n                tagsnew.push(tags[i]);\r\n            }\r\n        }\r\n        var json = '';\r\n        if (tagsnew.length) {\r\n            json = JSON.stringify(tagsnew);\r\n        }\r\n        input.val(json);\r\n\r\n        tag.remove();\r\n    };\r\n\r\n    /**\r\n     * Render the selection.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.render = function () {\r\n        var self = this;\r\n        self.rootel.removeClass('has-tags');\r\n        \r\n        var input = $('input[name=\"recipientjson\"]');\r\n\r\n        var json = input.val();\r\n        var tags = [];\r\n        if (json) {\r\n            tags = JSON.parse(json);\r\n        }\r\n\r\n        if (!tags.length) {\r\n            self.rootel.find('.recipient-selection').html(self.strings.noselectionstr);\r\n            return;\r\n        }\r\n\r\n        // Render the tag from a template.\r\n        var data = [];\r\n        if (self.allowmultiple) {\r\n            data = {tags: tags};\r\n        } else {\r\n            data = {tags: tags.pop()};\r\n        }\r\n        Templates.render('mod_psgrading/recipient_selector_tags', data)\r\n            .then(function(html) {\r\n                self.rootel.find('.recipient-selection').html(html);\r\n                self.rootel.addClass('has-tags');\r\n                self.rootel.removeClass('adding-tag');\r\n                self.rootel.find('.recipient-autocomplete').val('');\r\n            }).fail(function(reason) {\r\n                Log.error(reason);\r\n            });\r\n\r\n    };\r\n\r\n    /**\r\n     * Search.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.search = function (searchel) {\r\n        var self = this;\r\n        self.hasresults = false;\r\n\r\n        if (searchel.val() == '') {\r\n            return;\r\n        }\r\n\r\n        self.rootel.addClass('searching');\r\n\r\n        Ajax.call([{\r\n            methodname: 'mod_psgrading_get_recipient_users',\r\n            args: { \r\n                query: searchel.val(),\r\n                types: JSON.stringify(self.types),\r\n                roles: JSON.stringify(self.roles),\r\n            },\r\n            done: function(response) {\r\n                if (response.length) {\r\n                    self.hasresults = true;\r\n                    // Render the results.\r\n                    Templates.render('mod_psgrading/recipient_selector_results', { users : response }) \r\n                        .then(function(html) {\r\n                            var results = self.rootel.find('.recipient-results');\r\n                            results.html(html);\r\n                            self.rootel.addClass('showing-results');\r\n                            results.addClass('active');\r\n                            self.rootel.removeClass('searching');\r\n                        }).fail(function(reason) {\r\n                            Log.error(reason);\r\n                        });\r\n                } else {\r\n                    self.rootel.removeClass('searching');\r\n                    self.rootel.find('.recipient-results').removeClass('active');\r\n                    self.rootel.removeClass('showing-results');\r\n                }\r\n            },\r\n            fail: function(reason) {\r\n                self.rootel.removeClass('searching');\r\n                Log.error('mod_psgrading/recipientselector: failed to search.');\r\n                Log.debug(reason);\r\n            }\r\n        }]);\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.unfocus = function () {\r\n        var self = this;\r\n        self.rootel.find('.recipient-results').removeClass('active');\r\n        self.rootel.removeClass('showing-results');\r\n    };\r\n\r\n    /**\r\n     * Leave the autocomplete field.\r\n     *\r\n     * @method\r\n     */\r\n    RecipientSelector.prototype.refocus = function () {\r\n        var self = this;\r\n        if (self.rootel.find('.recipient-autocomplete').val() && self.hasresults) {\r\n            self.rootel.addClass('showing-results');\r\n            self.rootel.find('.recipient-results').addClass('active');\r\n        }\r\n    };\r\n\r\n    return {\r\n        init: init\r\n    };\r\n});"],"file":"recipientselector.min.js"}