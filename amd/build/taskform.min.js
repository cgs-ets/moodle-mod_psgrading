define(["jquery","core/log","core/templates","core/ajax","core/str"],function(o,a,n,i,e){"use strict";function t(e){var t=this;t.rootel=e,t.formjson=t.getFormJSON(),t.autosaving=!1,t.savestatus=t.rootel.find("#savestatus")}return t.prototype.main=function(){var n=this;n.rootel.on("blur",'input[type="text"], select, textarea',function(e){o(this).closest(".criterions").length&&n.regeneraterubricjson(),n.autoSave()}),setInterval(function(){n.regeneraterubricjson(),n.autoSave()},15e3),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=o(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=o(this);n.deleteCriterion(e)}),n.rootel.on("click","#btn-savedraft",function(e){e.preventDefault(),window.onbeforeunload=null,n.regeneraterubricjson(),n.autosaving=!1,n.autoSave(!1),n.rootel.find('[name="action"]').val("savedraft"),n.rootel.submit()}),n.rootel.on("click","#btn-discardchanges",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("discardchanges"),n.rootel.submit()}),n.rootel.on("click","#btn-publish",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("publish"),n.rootel.submit()}),n.templates={CRITERION:"mod_psgrading/rubric_selector_criterionform"};var e=[];e.push(n.loadTemplate("CRITERION")),o.when.apply(o,e).then(function(){n.rootel.addClass("preloads-completed")})},t.prototype.getFormJSON=function(){var e={id:o('input[name="edit"]').val(),taskname:o('input[name="taskname"]').val(),pypuoi:o('select[name="pypuoi"]').val(),outcomes:o('textarea[name="outcomes"]').val(),rubricjson:o('input[name="rubricjson"]').val(),evidencejson:""};return JSON.stringify(e)},t.prototype.autoSave=function(e){var t,n=this;n.autosaving||((t=n.getFormJSON()).length<=205||n.formjson!=t&&(n.formjson=t,n.statusSaving(),void 0===e&&(e=!0),i.call([{methodname:"mod_psgrading_autosave",args:{formjson:t},done:function(){n.statusSaved()},fail:function(e){a.debug(e),n.statusSaveFailed()}}],e)))},t.prototype.regeneraterubricjson=function(){var e=o('input[name="rubricjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=o(this),e={description:e.find("[name=criterion]").val(),level2:e.find("[name=goodstart]").val(),level3:e.find("[name=makingstride]").val(),level4:e.find("[name=gorunwithit]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?1:0};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},t.prototype.addCriterion=function(){var t=this;n.render(t.templates.CRITERION,{criterions:[{subject:""}]}).done(function(e){t.rootel.find(".criterions").append(e)})},t.prototype.toggleCriterion=function(e){var t=this,n=e.closest(".hidden-control"),o=n.closest(".tbl-tr"),e=n.find("input"),n=n.find(".desc");e.is(":checked")?(e.prop("checked",!1),o.removeClass("criterion-hidden"),n.html("Hide from students")):(e.prop("checked",!0),o.addClass("criterion-hidden"),n.html("Hidden from students")),t.regeneraterubricjson(),t.autosaving=!1,t.autoSave()},t.prototype.deleteCriterion=function(e){var t=this;e.closest(".tbl-tr").fadeOut(200,function(){o(this).remove(),t.regeneraterubricjson(),t.autosaving=!1,t.autoSave()})},t.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Draft saved</div>'),window.onbeforeunload=null},t.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Changes unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(){a.debug("mod_psgrading/task: initializing");var e=o('form[data-form="psgrading-task"]');e.length?new t(e).main():a.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});