define(["jquery","core/log","core/templates","core/ajax","core/str"],function(o,i,n,a,e){"use strict";function t(e){var t=this;t.rootel=e,t.formjson=t.getFormJSON(),t.autosaving=!1,t.savestatus=t.rootel.find("#savestatus")}return t.prototype.main=function(){var n=this;n.rootel.on("blur",'input[type="text"], select, textarea',function(e){o(this).closest(".criterions").length&&n.regenerateRubricJSON(),n.autoSave()}),n.rootel.on("change",".evidence-selector .cmid",function(){n.regenerateEvidenceJSON(),n.autosaving=!1,n.autoSave()}),setInterval(function(){n.regenerateAndSave()},15e3),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=o(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=o(this);n.deleteCriterion(e)}),n.rootel.on("click","#btn-savedraft",function(e){e.preventDefault(),window.onbeforeunload=null,n.autosaving=!1,n.regenerateAndSave(!1),n.rootel.find('[name="action"]').val("savedraft"),n.rootel.submit()}),n.rootel.on("click","#btn-discardchanges",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("discardchanges"),n.rootel.submit()}),n.rootel.on("click","#btn-publish",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("publish"),n.rootel.submit()}),n.templates={CRITERION:"mod_psgrading/rubric_selector_criterionform"};var e=[];e.push(n.loadTemplate("CRITERION")),o.when.apply(o,e).then(function(){n.rootel.addClass("preloads-completed")})},t.prototype.getFormJSON=function(){var e={id:o('input[name="edit"]').val(),taskname:o('input[name="taskname"]').val(),pypuoi:o('select[name="pypuoi"]').val(),outcomes:o('textarea[name="outcomes"]').val(),rubricjson:o('input[name="rubricjson"]').val(),evidencejson:o('input[name="evidencejson"]').val()};return JSON.stringify(e)},t.prototype.regenerateAndSave=function(e){var t=this;t.regenerateEvidenceJSON(),t.regenerateRubricJSON(),t.autoSave(e)},t.prototype.autoSave=function(e){var t,n=this;n.autosaving||((t=n.getFormJSON()).length<=205||n.formjson!=t&&(n.formjson=t,n.statusSaving(),void 0===e&&(e=!0),a.call([{methodname:"mod_psgrading_autosave",args:{formjson:t},done:function(){n.statusSaved()},fail:function(e){i.debug(e),n.statusSaveFailed()}}],e)))},t.prototype.regenerateEvidenceJSON=function(){var e=o('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e={id:o(this).val()};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},t.prototype.regenerateRubricJSON=function(){var e=o('input[name="rubricjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=o(this),e={description:e.find("[name=criterion]").val(),level2:e.find("[name=goodstart]").val(),level3:e.find("[name=makingstride]").val(),level4:e.find("[name=gorunwithit]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},t.prototype.addCriterion=function(){var t=this;n.render(t.templates.CRITERION,{criterions:[{subject:""}]}).done(function(e){t.rootel.find(".criterions").append(e)})},t.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible")),this.autosaving=!1,this.regenerateAndSave()},t.prototype.deleteCriterion=function(e){var t=this;e.closest(".tbl-tr").fadeOut(200,function(){o(this).remove(),t.autosaving=!1,t.regenerateAndSave()})},t.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Draft saved</div>'),window.onbeforeunload=null},t.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Changes unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(){i.debug("mod_psgrading/task: initializing");var e=o('form[data-form="psgrading-task"]');e.length?new t(e).main():i.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});