define(["jquery","core/log","core/templates","core/ajax"],function(n,o,a,i){"use strict";function t(e){var t=this;t.rootel=e,t.formjson=t.getFormJSON(),t.autosaveenabled=!1,t.autosaving=!1,t.savestatus=t.rootel.find("#savestatus"),t.rootel.find("#id_cancel").val("Save and exit")}return t.prototype.main=function(){var t=this;t.rootel.on("change","#autosave-switch",function(){this.checked?(t.autosaveenabled=!0,t.formjson="",n(this).closest(".autosave-control").addClass("active"),t.regeneraterubricjson(),t.autoSave()):(t.autosaveenabled=!1,n(this).closest(".autosave-control").removeClass("active"),window.onbeforeunload=function(){return"Are you sure?"})}),t.rootel.on("blur","input, select, textarea",function(e){n(this).closest(".criterions").length&&t.regeneraterubricjson(),t.autoSave()}),setInterval(function(){t.regeneraterubricjson(),t.autoSave()},15e3),t.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),t.addCriterion()}),t.rootel.on("click",".toggle-hide",function(e){e.preventDefault();e=n(this);t.toggleCriterion(e)}),t.rootel.on("click","#id_cancel",function(e){e.preventDefault(),t.regeneraterubricjson(),t.autosaveenabled=!0,t.autosaving=!1,t.autoSave(!1),n(this).submit()}),t.templates={CRITERION:"mod_psgrading/rubric_selector_criterionform"};var e=[];e.push(t.loadTemplate("CRITERION")),n.when.apply(n,e).then(function(){t.rootel.addClass("preloads-completed")})},t.prototype.getFormJSON=function(){var e={id:n('input[name="edit"]').val(),taskname:n('input[name="taskname"]').val(),pypuoi:n('select[name="pypuoi"]').val(),outcomes:n('textarea[name="outcomes"]').val(),rubricjson:n('input[name="rubricjson"]').val(),evidencejson:""};return JSON.stringify(e)},t.prototype.autoSave=function(e){var t,a=this;a.autosaveenabled&&(a.autosaving||((t=a.getFormJSON()).length<=205||a.formjson!=t&&(a.formjson=t,a.statusSaving(),void 0===e&&(e=!0),i.call([{methodname:"mod_psgrading_autosave",args:{formjson:t},done:function(){a.statusSaved()},fail:function(e){o.debug(e),a.statusSaveFailed()}}],e))))},t.prototype.regeneraterubricjson=function(){var e=n('input[name="rubricjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=n(this),e={description:e.find("[name=criterion]").val(),level2:e.find("[name=goodstart]").val(),level3:e.find("[name=makingstride]").val(),level4:e.find("[name=gorunwithit]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").val()};t.push(e)});var a="";return t.length&&(a=JSON.stringify(t),e.val(a)),a},t.prototype.addCriterion=function(){var t=this;a.render(t.templates.CRITERION,{criterions:[{subject:""}]}).done(function(e){t.rootel.find(".criterions").append(e)})},t.prototype.toggleCriterion=function(e){var t=this,a=e.prev(),n=a.closest(".tbl-tr");1==a.val()?(a.val(0),n.removeClass("criterion-hidden"),e.html('<i class="fa fa-eye fa-fw" aria-hidden="true"></i>').addClass("btn-secondary").removeClass("btn-primary")):(a.val(1),n.addClass("criterion-hidden"),e.html('<i class="fa fa-eye-slash fa-fw" aria-hidden="true"></i>').addClass("btn-primary").removeClass("btn-secondary")),t.regeneraterubricjson(),t.autosaving=!1,t.autoSave()},t.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Progress saved</div>'),window.onbeforeunload=null},t.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.loadTemplate=function(e){return a.render(this.templates[e],{})},{init:function(){o.debug("mod_psgrading/task: initializing");var e=n('form[data-form="psgrading-task"]');e.length?new t(e).main():o.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});