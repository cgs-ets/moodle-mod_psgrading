define(["jquery","core/log","core/templates","core/ajax","core/str"],function(o,i,n,a,e){"use strict";function r(e,t){var n=this;n.rootel=e,n.formjson=n.getFormJSON(),n.autosaving=!1,n.savestatus=n.rootel.find("#savestatus"),n.stubcriterion=t}return r.prototype.main=function(){var n=this;n.rootel.on("blur",'input[type="text"], select, textarea',function(e){o(this).closest(".criterions").length&&n.regenerateCriterionJSON(),n.autoSave()}),n.rootel.on("change",".evidence-selector .cmid",function(){n.regenerateEvidenceJSON(),n.autosaving=!1,n.autoSave()}),setInterval(function(){n.regenerateAndSave()},15e3),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=o(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=o(this);n.deleteCriterion(e)}),n.rootel.on("click","#btn-savedraft",function(e){e.preventDefault(),window.onbeforeunload=null,n.autosaving=!1,n.regenerateAndSave(!1),n.rootel.find('[name="action"]').val("savedraft"),n.rootel.submit()}),n.rootel.on("click","#btn-discardchanges",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("discardchanges"),n.rootel.submit()}),n.rootel.on("click","#btn-publish",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("publish"),n.rootel.submit()}),n.rootel.on("change","select",function(e){var t=o(this);t.removeClass("selected"),t.children(":selected").val()&&t.addClass("selected")}),n.rootel.find("select").change(),n.templates={CRITERION:"mod_psgrading/criterion_selector_row"};var e=[];e.push(n.loadTemplate("CRITERION")),o.when.apply(o,e).then(function(){n.rootel.addClass("preloads-completed")}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-criterions"),new Sortable(e,{handle:".btn-reorder",animation:150,ghostClass:"reordering"}))},r.prototype.SortEnd=function(e){self=this,console.log(e)},r.prototype.getFormJSON=function(){var e={id:o('input[name="edit"]').val(),taskname:o('input[name="taskname"]').val(),pypuoi:o('select[name="pypuoi"]').val(),outcomes:o('textarea[name="outcomes"]').val(),criterionjson:o('input[name="criterionjson"]').val(),evidencejson:o('input[name="evidencejson"]').val()};return JSON.stringify(e)},r.prototype.regenerateAndSave=function(e){var t=this;t.regenerateEvidenceJSON(),t.regenerateCriterionJSON(),t.autoSave(e)},r.prototype.autoSave=function(e){var t,n=this;n.autosaving||((t=n.getFormJSON()).length<=205||n.formjson!=t&&(n.formjson=t,n.statusSaving(),void 0===e&&(e=!0),a.call([{methodname:"mod_psgrading_autosave",args:{formjson:t},done:function(){n.statusSaved()},fail:function(e){i.debug(e),n.statusSaveFailed()}}],e)))},r.prototype.regenerateEvidenceJSON=function(){var e=o('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e={evidencetype:"cm",refdata:o(this).val()};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},r.prototype.regenerateCriterionJSON=function(){var e=o('input[name="criterionjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=o(this),e={description:e.find("[name=description]").val(),level2:e.find("[name=level2]").val(),level3:e.find("[name=level3]").val(),level4:e.find("[name=level4]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},r.prototype.addCriterion=function(){var t=this,e={criterions:[t.stubcriterion]};n.render(t.templates.CRITERION,e).done(function(e){t.rootel.find(".criterions").append(e)})},r.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible")),this.autosaving=!1,this.regenerateAndSave()},r.prototype.deleteCriterion=function(e){var t=this;e.closest(".tbl-tr").fadeOut(200,function(){o(this).remove(),t.autosaving=!1,t.regenerateAndSave()})},r.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},r.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Draft saved</div>'),window.onbeforeunload=null},r.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Changes unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},r.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(e){i.debug("mod_psgrading/task: initializing");var t=o('form[data-form="psgrading-task"]');t.length?new r(t,e).main():i.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});