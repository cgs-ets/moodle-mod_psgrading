define(["jquery","core/log","core/templates","core/ajax","core/str"],function(a,o,n,i,e){"use strict";function t(e){var t=this;t.rootel=e,t.formjson=t.getFormJSON(),t.autosaving=!1,t.savestatus=t.rootel.find("#savestatus")}return t.prototype.main=function(){var t=this;t.rootel.on("blur","input, select, textarea",function(e){a(this).closest(".criterions").length&&t.regeneraterubricjson(),t.autoSave()}),setInterval(function(){t.regeneraterubricjson(),t.autoSave()},15e3),t.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),t.addCriterion()}),t.rootel.on("click",".toggle-hide",function(e){e.preventDefault();e=a(this);t.toggleCriterion(e)}),t.rootel.on("click","#btn-savedraft",function(e){e.preventDefault(),window.onbeforeunload=null,t.regeneraterubricjson(),t.autosaving=!1,t.autoSave(!1),t.rootel.find('[name="action"]').val("savedraft"),t.rootel.submit()}),t.rootel.on("click","#btn-discardchanges",function(e){e.preventDefault(),window.onbeforeunload=null,t.rootel.find('[name="action"]').val("discardchanges"),t.rootel.submit()}),t.rootel.on("click","#btn-publish",function(e){e.preventDefault(),window.onbeforeunload=null,t.rootel.find('[name="action"]').val("publish"),t.rootel.submit()}),t.templates={CRITERION:"mod_psgrading/rubric_selector_criterionform"};var e=[];e.push(t.loadTemplate("CRITERION")),a.when.apply(a,e).then(function(){t.rootel.addClass("preloads-completed")})},t.prototype.getFormJSON=function(){var e={id:a('input[name="edit"]').val(),taskname:a('input[name="taskname"]').val(),pypuoi:a('select[name="pypuoi"]').val(),outcomes:a('textarea[name="outcomes"]').val(),rubricjson:a('input[name="rubricjson"]').val(),evidencejson:""};return JSON.stringify(e)},t.prototype.autoSave=function(e){var t,n=this;n.autosaving||((t=n.getFormJSON()).length<=205||n.formjson!=t&&(n.formjson=t,n.statusSaving(),void 0===e&&(e=!0),i.call([{methodname:"mod_psgrading_autosave",args:{formjson:t},done:function(){n.statusSaved()},fail:function(e){o.debug(e),n.statusSaveFailed()}}],e)))},t.prototype.regeneraterubricjson=function(){var e=a('input[name="rubricjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=a(this),e={description:e.find("[name=criterion]").val(),level2:e.find("[name=goodstart]").val(),level3:e.find("[name=makingstride]").val(),level4:e.find("[name=gorunwithit]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").val()};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},t.prototype.addCriterion=function(){var t=this;n.render(t.templates.CRITERION,{criterions:[{subject:""}]}).done(function(e){t.rootel.find(".criterions").append(e)})},t.prototype.toggleCriterion=function(e){var t=this,n=e.prev(),a=n.closest(".tbl-tr");1==n.val()?(n.val(0),a.removeClass("criterion-hidden"),e.html('<i class="fa fa-eye fa-fw" aria-hidden="true"></i>').addClass("btn-secondary").removeClass("btn-primary")):(n.val(1),a.addClass("criterion-hidden"),e.html('<i class="fa fa-eye-slash fa-fw" aria-hidden="true"></i>').addClass("btn-primary").removeClass("btn-secondary")),t.regeneraterubricjson(),t.autosaving=!1,t.autoSave()},t.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Draft saved</div>'),window.onbeforeunload=null},t.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Changes unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},t.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(){o.debug("mod_psgrading/task: initializing");var e=a('form[data-form="psgrading-task"]');e.length?new t(e).main():o.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});