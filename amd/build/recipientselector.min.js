define(["jquery","core/log","core/ajax","core/templates","core/str"],function(l,i,t,r,n){"use strict";function s(e,t,o,r){var i=this;i.rootel=e,i.component="mod_psgrading",i.types=t,i.roles=o,i.allowmultiple=r,i.allowmultiple?i.rootel.addClass("allow-multiple"):i.rootel.addClass("allow-single"),i.strings={},n.get_strings([{key:"postform:recipientnoselection",component:i.component}]).then(function(e){i.strings.noselectionstr=e[0]})}return s.prototype.main=function(){var o,r=this;r.render(),r.rootel.on("keyup",".recipient-autocomplete",function(e){clearTimeout(o);var t=l(this);13==e.which?r.search(t):o=setTimeout(function(){r.search(t)},500)}),r.rootel.on("click",".recipient-result",function(e){e.preventDefault();e=l(this);r.add(e)}),r.rootel.on("click",".recipient-tag",function(e){e.preventDefault();e=l(this);r.remove(e)}),r.rootel.on("focus",".recipient-autocomplete",function(e){r.refocus()}),l(document).on("click",function(e){e=l(e.target);e.is(".recipient-autocomplete")||e.is(".recipient-result")||r.unfocus()})},s.prototype.add=function(e){var t=this;t.unfocus(),t.rootel.addClass("adding-tag");var o,r=l('input[name="recipientjson"]'),i=new Array;for(r.val()&&(i=JSON.parse(r.val())),o=0;o<i.length;o++)if(i[o].idfield==e.data("idfield"))return void t.render();var n={taguid:Date.now(),idfield:e.data("idfield"),photourl:e.find("img").attr("src"),fullname:e.find("span").first().text(),type:e.data("type")};i.push(n);n=JSON.stringify(i);r.val(n),t.render()},s.prototype.remove=function(e){for(var t=e.data("taguid"),o=l('input[name="recipientjson"]'),r=JSON.parse(o.val()),i=new Array,n=0;n<r.length;n++){r[n].taguid!=t&&i.push(r[n])}var s="";i.length&&(s=JSON.stringify(i)),o.val(s),e.remove()},s.prototype.render=function(){var t=this;t.rootel.removeClass("has-tags");var e=l('input[name="recipientjson"]').val(),o=[];e&&(o=JSON.parse(e)),o.length?(e=[],e=t.allowmultiple?{tags:o}:{tags:o.pop()},r.render("mod_psgrading/recipient_selector_tags",e).then(function(e){t.rootel.find(".recipient-selection").html(e),t.rootel.addClass("has-tags"),t.rootel.removeClass("adding-tag"),t.rootel.find(".recipient-autocomplete").val("")}).fail(function(e){i.error(e)})):t.rootel.find(".recipient-selection").html(t.strings.noselectionstr)},s.prototype.search=function(e){var o=this;o.hasresults=!1,""!=e.val()&&(o.rootel.addClass("searching"),t.call([{methodname:"mod_psgrading_get_recipient_users",args:{query:e.val(),types:JSON.stringify(o.types),roles:JSON.stringify(o.roles)},done:function(e){e.length?(o.hasresults=!0,r.render("mod_psgrading/recipient_selector_results",{users:e}).then(function(e){var t=o.rootel.find(".recipient-results");t.html(e),o.rootel.addClass("showing-results"),t.addClass("active"),o.rootel.removeClass("searching")}).fail(function(e){i.error(e)})):(o.rootel.removeClass("searching"),o.rootel.find(".recipient-results").removeClass("active"),o.rootel.removeClass("showing-results"))},fail:function(e){o.rootel.removeClass("searching"),i.error("mod_psgrading/recipientselector: failed to search."),i.debug(e)}}]))},s.prototype.unfocus=function(){this.rootel.find(".recipient-results").removeClass("active"),this.rootel.removeClass("showing-results")},s.prototype.refocus=function(){this.rootel.find(".recipient-autocomplete").val()&&this.hasresults&&(this.rootel.addClass("showing-results"),this.rootel.find(".recipient-results").addClass("active"))},{init:function(e,t,o){i.debug("mod_psgrading/recipientselector: initializing the recipient-selector component");var r=l(".recipient-selector").first();if(r.length){void 0===e&&(e=["user"]),void 0===t&&(t=["student"]),void 0===o&&(o=!0);o=new s(r,e,t,o);return o.main(),o}i.error("mod_psgrading/recipientselector: recipient-selector root element not found!")}}});