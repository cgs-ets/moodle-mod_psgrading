define(["jquery","core/log","core/templates","core/ajax","core/str"],function(o,t,n,e,r){"use strict";function i(e){var t=this;t.rootel=e;e=document.createElement("textarea");e.innerHTML=t.rootel.find(".criterion-selector").data("stub"),t.stubcriterion=o.parseJSON(e.value),t.regenerateEvidenceJSON(),t.regenerateCriterionJSON()}return i.prototype.main=function(){var n=this;n.rootel.on("click","#btn-cancel",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("cancel"),n.rootel.submit()}),n.rootel.on("click","#btn-delete",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("delete"),n.rootel.submit()}),n.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("save"),n.regenerateEvidenceJSON(),n.regenerateCriterionJSON(),n.rootel.submit()}),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=o(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=o(this);n.deleteCriterion(e)}),n.rootel.on("change","select",function(e){var t=o(this);t.removeClass("selected"),t.children(":selected").val()&&t.addClass("selected")}),n.rootel.find("select").change(),n.templates={CRITERION:"mod_psgrading/criterion_selector_row"};var e=[];e.push(n.loadTemplate("CRITERION")),o.when.apply(o,e).then(function(){n.rootel.addClass("preloads-completed")}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-criterions"),new Sortable(e,{handle:".btn-reorder",animation:150,ghostClass:"reordering"}))},i.prototype.SortEnd=function(e){self=this},i.prototype.regenerateEvidenceJSON=function(){var e=o('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e={evidencetype:"cm",refdata:o(this).val()};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},i.prototype.regenerateCriterionJSON=function(){var e=o('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=o(this),t=e.find("[name=subject]").val();null==t&&(t="");e={id:e.data("id"),description:e.find("[name=description]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),subject:t,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};n.push(e)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},i.prototype.addCriterion=function(){var t=this,e={criterions:[t.stubcriterion]};n.render(t.templates.CRITERION,e).done(function(e){t.rootel.find(".criterions").append(e)})},i.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible"))},i.prototype.deleteCriterion=function(e){e.closest(".tbl-tr").fadeOut(200,function(){o(this).remove()})},i.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(){t.debug("mod_psgrading/task: initializing");var e=o('form[data-form="psgrading-task"]');e.length?new i(e).main():t.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});