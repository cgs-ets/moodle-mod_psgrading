define(["jquery","core/log","core/templates","core/ajax","core/str"],function(i,t,n,e,o){"use strict";function r(e){var t=this;t.rootel=e;e=document.createElement("textarea");e.innerHTML=t.rootel.find(".criterion-selector").data("stub"),t.stubcriterion=i.parseJSON(e.value),t.regenerateEvidenceJSON(),t.regenerateCriterionJSON()}return r.prototype.main=function(){var n=this;n.rootel.on("click",'input[name="cancel"]',function(e){n.rootel.find('[name="action"]').val("cancel")}),n.rootel.on("click",'input[name="delete"]',function(e){n.rootel.find('[name="action"]').val("delete")}),n.rootel.on("click",'input[name="save"]',function(e){n.rootel.find('[name="action"]').val("save"),n.regenerateEvidenceJSON(),n.regenerateCriterionJSON(),t.debug("regenerated evidence and criteria json")}),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=i(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=i(this);n.deleteCriterion(e)}),n.rootel.on("click",".activity.labelonly",function(e){e.preventDefault();e=i(this);n.toggleEvidence(e)}),n.rootel.on("change","select",function(e){var t=i(this);t.removeClass("selected"),t.children(":selected").val()&&t.addClass("selected")}),n.rootel.find("select").change(),n.templates={CRITERION:"mod_psgrading/criterion_selector_row"};var e=[];e.push(n.loadTemplate("CRITERION")),i.when.apply(i,e).then(function(){n.rootel.addClass("preloads-completed")}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-criterions"),new Sortable(e,{handle:".btn-reorder",animation:150,ghostClass:"reordering"}))},r.prototype.SortEnd=function(e){self=this},r.prototype.regenerateEvidenceJSON=function(){var e=i('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e=i(this),e={evidencetype:"cm_"+e.data("modname"),refdata:e.val()};t.push(e)});var n="";t.length&&(n=JSON.stringify(t)),e.val(n)},r.prototype.regenerateCriterionJSON=function(){var e=i('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=i(this),t=e.find("[name=subject]").val();null==t&&(t="");e={id:e.data("id"),description:e.find("[name=description]").val(),level5:e.find("[name=level5]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),level1:e.find("[name=level1]").val(),subject:t,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};n.push(e)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},r.prototype.addCriterion=function(){var t=this,e={criterions:[t.stubcriterion]};n.render(t.templates.CRITERION,e).done(function(e){t.rootel.find(".criterions").append(e)})},r.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible"))},r.prototype.deleteCriterion=function(e){e.closest(".tbl-tr").fadeOut(200,function(){i(this).remove()})},r.prototype.toggleEvidence=function(e){var t=e.data("cmid");e.hasClass("subhidden")?(this.rootel.find('.activity.sub[data-cmid="'+t+'"]').show(),e.removeClass("subhidden")):(this.rootel.find('.activity.sub[data-cmid="'+t+'"]').hide(),e.addClass("subhidden"))},r.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},{init:function(){t.debug("mod_psgrading/task: initializing");var e=i('form[data-form="psgrading-task"]');e.length?new r(e).main():t.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});