define(["jquery","core/log","core/templates","core/ajax","core/str"],function(i,n,t,e,o){"use strict";function r(e){var n=this;n.rootel=e;e=document.createElement("textarea");e.innerHTML=n.rootel.find(".criterion-selector").data("stub"),n.stubcriterion=i.parseJSON(e.value),document.createElement("textarea").innerHTML=n.rootel.find(".engagement-selector").data("stub"),n.stubengagement=i.parseJSON(e.value),n.regenerateEvidenceJSON(),n.regenerateCriterionJSON(),n.regenerateEngagementJSON()}return r.prototype.main=function(){var t=this;t.rootel.on("click",'input[name="cancel"]',function(e){t.rootel.find('[name="action"]').val("cancel")}),t.rootel.on("click",'input[name="delete"]',function(e){t.rootel.find('[name="action"]').val("delete")}),t.rootel.on("click",'input[name="save"]',function(e){t.rootel.find('[name="action"]').val("save"),t.regenerateEvidenceJSON(),t.regenerateCriterionJSON(),t.regenerateEngagementJSON(),n.debug("regenerated evidence, engagement and criteria json")}),t.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),t.addCriterion()}),t.rootel.on("click",".toggle",function(e){var n=i(this);t.toggleCriterion(n)}),t.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=i(this);t.deleteCriterion(e)}),t.rootel.on("click","#btn-addengagement",function(e){e.preventDefault(),t.addEngagement()}),t.rootel.on("click",".toggle-engagement",function(e){var n=i(this);t.toggleEngagement(n)}),t.rootel.on("click",".btn-delete-engagement",function(e){e.preventDefault();e=i(this);t.deleteEngagement(e)}),t.rootel.on("click",".activity.labelonly",function(e){e.preventDefault();e=i(this);t.toggleEvidence(e)}),t.rootel.on("change","select",function(e){var n=i(this);n.removeClass("selected"),n.children(":selected").val()&&n.addClass("selected")}),t.rootel.find("select").change(),t.templates={CRITERION:"mod_psgrading/criterion_selector_row",ENGAGEMENT:"mod_psgrading/engagement_selector_row"};var e=[];e.push(t.loadTemplate("CRITERION")),e.push(t.loadTemplate("ENGAGEMENT")),i.when.apply(i,e).then(function(){t.rootel.addClass("preloads-completed")}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-criterions"),new Sortable(e,{handle:".btn-reorder",animation:150,ghostClass:"reordering"}))},r.prototype.SortEnd=function(e){self=this},r.prototype.regenerateEvidenceJSON=function(){var e=i('input[name="evidencejson"]'),n=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e=i(this),e={evidencetype:"cm_"+e.data("modname"),refdata:e.val()};n.push(e)});var t="";n.length&&(t=JSON.stringify(n)),e.val(t)},r.prototype.regenerateCriterionJSON=function(){var e=i('input[name="criterionjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=i(this),n=e.find("[name=subject]").val();null==n&&(n="");e={id:e.data("id"),description:e.find("[name=description]").val(),level5:e.find("[name=level5]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),level1:e.find("[name=level1]").val(),subject:n,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},r.prototype.regenerateEngagementJSON=function(){var e=i('input[name="engagementjson"]'),t=new Array;this.rootel.find(".engagements .tbl-tr").each(function(){var e=i(this),n=e.find("[name=subject]").val();null==n&&(n="");e={id:e.data("id"),description:e.find("[name=description]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),level1:e.find("[name=level1]").val(),subject:n,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),console.log(n),n},r.prototype.addCriterion=function(){var n=this,e={criterions:[n.stubcriterion]};t.render(n.templates.CRITERION,e).done(function(e){n.rootel.find(".criterions").append(e)})},r.prototype.toggleCriterion=function(e){var n=e.closest(".hidden-control"),t=n.closest(".tbl-tr"),e=n.find("input"),n=n.find(".desc");e.is(":checked")?(e.prop("checked",!1),t.addClass("criterion-hidden"),n.html("Hidden from students")):(e.prop("checked",!0),t.removeClass("criterion-hidden"),n.html("Visible"))},r.prototype.deleteCriterion=function(e){e.closest(".tbl-tr").fadeOut(200,function(){i(this).remove()})},r.prototype.addEngagement=function(){var n=this,e={engagements:[n.stubengagement]};t.render(n.templates.ENGAGEMENT,e).done(function(e){n.rootel.find(".engagements").append(e)})},r.prototype.toggleEngagement=function(e){var n=e.closest(".hidden-control"),t=n.closest(".tbl-tr"),e=n.find("input"),n=n.find(".desc");e.is(":checked")?(e.prop("checked",!1),t.addClass("criterion-hidden"),n.html("Hidden from students")):(e.prop("checked",!0),t.removeClass("criterion-hidden"),n.html("Visible"))},r.prototype.deleteEngagement=function(e){e.closest(".tbl-tr").fadeOut(200,function(){i(this).remove()})},r.prototype.toggleEvidence=function(e){var n=e.data("cmid");e.hasClass("subhidden")?(this.rootel.find('.activity.sub[data-cmid="'+n+'"]').show(),e.removeClass("subhidden")):(this.rootel.find('.activity.sub[data-cmid="'+n+'"]').hide(),e.addClass("subhidden"))},r.prototype.loadTemplate=function(e){return t.render(this.templates[e],{})},{init:function(){n.debug("mod_psgrading/task: initializing");var e=i('form[data-form="psgrading-task"]');e.length?new r(e).main():n.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});