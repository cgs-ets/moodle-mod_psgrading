define(["jquery","core/log","core/templates","core/modal_factory","core/modal_events"],function(i,t,n,a,o){"use strict";function r(e){var t=this;t.rootel=e;e=document.createElement("textarea");e.innerHTML=t.rootel.find(".criterion-selector").data("stub"),t.stubcriterion=i.parseJSON(e.value),document.createElement("textarea").innerHTML=t.rootel.find(".engagement-selector").data("stub"),t.stubengagement=i.parseJSON(e.value),t.regenerateEvidenceJSON(),t.regenerateCriterionJSON(),t.regenerateEngagementJSON()}return r.prototype.main=function(){var n=this;n.rootel.on("click",'input[name="cancel"]',function(e){n.rootel.find('[name="action"]').val("cancel")}),n.rootel.on("click",'input[name="delete"]',function(e){n.rootel.find('[name="action"]').val("delete")}),n.rootel.on("click",'input[name="save"]',function(e){n.rootel.find('[name="action"]').val("save"),n.regenerateEvidenceJSON(),n.regenerateCriterionJSON(),n.regenerateEngagementJSON(),t.debug("regenerated evidence, engagement and criteria json")}),n.rootel.on("click","#btn-addcriterion",function(e){e.preventDefault(),n.addCriterion()}),n.rootel.on("click",".toggle",function(e){var t=i(this);n.toggleCriterion(t)}),n.rootel.on("click",".btn-delete",function(e){e.preventDefault();e=i(this);n.deleteCriterion(e)}),n.rootel.on("click","#btn-addengagement",function(e){e.preventDefault(),n.addEngagement()}),n.rootel.on("click",".toggle-engagement",function(e){var t=i(this);n.toggleEngagement(t)}),n.rootel.on("click",".btn-delete-engagement",function(e){e.preventDefault();e=i(this);n.deleteEngagement(e)}),n.rootel.on("click",".activity.labelonly",function(e){e.preventDefault();e=i(this);n.toggleEvidence(e)}),n.rootel.on("change",'input[name="enableweights"]',function(e){n.toggleWeights(),n.showWeightChangeWarning(),n.checksumweights()}),n.toggleWeights(),n.rootel.on("change","select",function(e){var t=i(this);t.removeClass("selected"),t.children(":selected").val()&&t.addClass("selected")}),n.rootel.on("change",".mod-psgrading-weight > select",function(){n.checksumweights()}),n.rootel.find('input[name="enableweights"]').is(":checked")&&n.checksumweights(),n.rootel.find("select").change(),n.templates={CRITERION:"mod_psgrading/criterion_selector_row",ENGAGEMENT:"mod_psgrading/engagement_selector_row"},n.modals={DELETE:null};var e=[];e.push(n.loadTemplate("CRITERION")),e.push(n.loadTemplate("ENGAGEMENT")),e.push(n.loadModal("DELETE","Confirm delete","Delete",a.types.SAVE_CANCEL)),i.when.apply(i,e).then(function(){n.rootel.addClass("preloads-completed")}),"undefined"!=typeof Sortable&&(e=document.getElementById("task-criterions"),new Sortable(e,{handle:".btn-reorder",animation:150,ghostClass:"reordering"}))},r.prototype.SortEnd=function(e){self=this},r.prototype.regenerateEvidenceJSON=function(){var e=i('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e=i(this),e={evidencetype:"cm_"+e.data("modname"),refdata:e.val()};t.push(e)});var n="";t.length&&(n=JSON.stringify(t)),e.val(n)},r.prototype.regenerateCriterionJSON=function(){var e=i('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=i(this),t=e.find("[name=subject]").val();null==t&&(t="");e={id:e.data("id"),description:e.find("[name=description]").val(),level5:e.find("[name=level5]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),level1:e.find("[name=level1]").val(),subject:t,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};n.push(e)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},r.prototype.regenerateEngagementJSON=function(){var e=i('input[name="engagementjson"]'),n=new Array;this.rootel.find(".engagements .tbl-tr").each(function(){var e=i(this),t=e.find("[name=subject]").val();null==t&&(t="");e={id:e.data("id"),description:e.find("[name=description]").val(),level4:e.find("[name=level4]").val(),level3:e.find("[name=level3]").val(),level2:e.find("[name=level2]").val(),level1:e.find("[name=level1]").val(),subject:t,weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};n.push(e)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),console.log(t),t},r.prototype.addCriterion=function(){var t=this,e={criterions:[t.stubcriterion]};console.log(e),n.render(t.templates.CRITERION,e).done(function(e){t.rootel.find(".criterions").append(e),t.toggleWeights(),t.checksumweights()})},r.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible"))},r.prototype.deleteCriterion=function(e){var t=this,n=e.closest(".tbl-tr");1<i("#task-criterions").children().length?(e=i(i(n.children("li")[0]).children()[0]).val(),t.modals.DELETE&&(t.modals.DELETE.setBody("<p>Are you sure you want to delete this criterion?<br><strong>"+e+"</strong></p>"),t.modals.DELETE.getRoot().on(o.save,function(e){n.fadeOut(200,function(){i(this).remove(),t.checksumweights()})}),t.modals.DELETE.show())):n.fadeOut(200,function(){i(this).remove(),t.checksumweights()})},r.prototype.addEngagement=function(){var t=this,e={engagements:[t.stubengagement]};n.render(t.templates.ENGAGEMENT,e).done(function(e){t.rootel.find(".engagements").append(e)})},r.prototype.toggleEngagement=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible"))},r.prototype.deleteEngagement=function(e){var t=e.closest(".tbl-tr");1<i("#task-engagement").children().length?(e=i(i(t.children("li")[0]).children()[0]).val(),this.modals.DELETE&&(this.modals.DELETE.setBody("<p>Are you sure you want to delete this engagement?<br><strong>"+e+"</strong></p>"),this.modals.DELETE.getRoot().on(o.save,function(e){t.fadeOut(200,function(){i(this).remove()})}),this.modals.DELETE.show())):t.fadeOut(200,function(){i(this).remove()})},r.prototype.toggleEvidence=function(e){var t=e.data("cmid");e.hasClass("subhidden")?(this.rootel.find('.activity.sub[data-cmid="'+t+'"]').show(),e.removeClass("subhidden")):(this.rootel.find('.activity.sub[data-cmid="'+t+'"]').hide(),e.addClass("subhidden"))},r.prototype.toggleWeights=function(){this.rootel.find('input[name="enableweights"]').is(":checked")?this.rootel.find(".criterions .mod-psgrading-weight").show():this.rootel.find(".criterions .mod-psgrading-weight").hide()},r.prototype.checksumweights=function(){var e=this;console.log("checksumweights");var t=0;e.rootel.find('input[name="enableweights"]').is(":checked")?(i(e.rootel).find(".mod-psgrading-weight > select").each(function(){var e=parseInt(i(this).val());isNaN(e)||(t+=e)}),console.log("Total weight: "+t),100<t?i(e.rootel).find(".psgrading-weights-alert").addClass("psgrading-weights-alert-show"):i(e.rootel).find(".psgrading-weights-alert").removeClass("psgrading-weights-alert-show")):i(e.rootel).find(".psgrading-weights-alert").removeClass("psgrading-weights-alert-show")},r.prototype.showWeightChangeWarning=function(){var e=this,t=e.rootel.find('input[name="edit"]');t.length&&0<t.val()&&(e.rootel.data("hasgrades")||0<e.rootel.find('[data-hasgrades="true"]').length)&&(e.rootel.find(".alert-warning").remove(),e.rootel.find('input[name="enableweights"]').closest(".fitem").after('<div class="alert alert-warning alert-dismissible fade show mt-2" role="alert"><strong>Weight Setting Changed:</strong> Existing student grades may be inconsistent. Consider re-grading students to ensure all grades use the same calculation method.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'))},r.prototype.loadTemplate=function(e){return n.render(this.templates[e],{})},r.prototype.loadModal=function(t,n,i,e){var o=this;return a.create({type:e}).then(function(e){e.setTitle(n),i&&e.setSaveButtonText(i),(o.modals[t]=e).getBackdrop(),e.getRoot().addClass("modal-"+t)})},{init:function(){t.debug("mod_psgrading/task: initializing");var e=i('form[data-form="psgrading-task"]');e.length?new r(e).main():t.error('mod_psgrading/tasks: form[data-form="psgrading-task"] not found!')}}});