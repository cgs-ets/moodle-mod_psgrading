define(["jquery","core/log","core/ajax"],function(n,i,r){"use strict";function a(e,t,o){var n=this;n.rootel=e,n.form=n.rootel.find('form[data-form="psgrading-mark"]'),n.userid=t,n.taskid=o}return a.prototype.main=function(){var e,t,o=this;o.rootel.on("change",".student-select",function(e){var t=n(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("change",".task-select",function(e){var t=n(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("change",".group-select",function(e){var t=n(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=n(this);o.selectLevel(e),i.debug("Adding leave page check..."),window.onbeforeunload=function(){return"You have unsaved changes!"}}),o.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,o.regenerateCriterionJSON(),o.rootel.find('[name="action"]').val("save"),o.form.submit()}),o.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,o.regenerateCriterionJSON(),o.rootel.find('[name="action"]').val("saveshownext"),o.form.submit()}),o.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,o.rootel.find('[name="action"]').val("reset"),o.form.submit()}),o.rootel.on("click","#save-to-comment-bank",function(e){e.preventDefault(),o.saveComment()}),o.rootel.on("click",".comment",function(e){e.preventDefault();var t=n(this).find(".text").html(),e=o.rootel.find("#id_comment");e.val()&&(t=e.val()+"\n"+t),e.val(t)}),o.rootel.on("click",".comment .delete",function(e){e.preventDefault(),e.stopPropagation();e=n(this);o.deleteComment(e)}),o.rootel.on("click",".myconnect-selector .btn-exit",function(e){o.rootel.find(".myconnect-selector").hide(),n("body").css("overflow","")}),"undefined"!=typeof Masonry&&(e=document.querySelector(".posts"),new Masonry(e,{itemSelector:".post-wrap",columnWidth:10,horizontalOrder:!0})),n("body").css("overflow","hidden"),o.rootel.find(".myconnect-selector .frame").scroll(function(){var e=n(this);clearTimeout(t),t=setTimeout(function(){e.scrollTop()+e.innerHeight()>=e[0].scrollHeight&&o.loadNextMyConnectPosts()},500)})},a.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},a.prototype.regenerateCriterionJSON=function(){var e=n('input[name="criterionjson"]'),o=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=n(this),t=e.find(".level.selected").first().data("level");void 0===t&&(t=0);t={id:e.data("id"),selectedlevel:t};o.push(t)});var t="";return o.length&&(t=JSON.stringify(o),e.val(t)),t},a.prototype.saveComment=function(){var t,e=this,o=e.rootel.find('textarea[name="comment"]');o.val().length&&((t=e.rootel.find(".comment-bank")).addClass("submitting"),e={comment:o.val(),taskid:e.taskid},r.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_comment",data:JSON.stringify(e)},done:function(e){t.find(".stored").html(e),t.removeClass("submitting")},fail:function(e){i.debug(e)}}]))},a.prototype.deleteComment=function(e){var t=e.closest(".comment");t.css("opacity","0.4"),r.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_comment",data:t.data("id")},done:function(e){t.fadeOut(300,function(){n(this).remove()})},fail:function(e){i.debug(e)}}])},{init:function(e,t){i.debug("mod_psgrading/mark: initializing");var o=n("#page-mod-psgrading-mark");o.length?new a(o,e,t).main():i.error("mod_psgrading/mark: #page-mod-psgrading-mark not found!")}}});