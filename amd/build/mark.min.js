define(["jquery","core/log","core/ajax"],function(r,c,i){"use strict";function t(e,n,o){var t=this;t.rootel=e,t.form=t.rootel.find('form[data-form="psgrading-mark"]'),t.userid=n,t.taskid=o,t.loadingmyconnect=!1}return t.prototype.main=function(){var n,i=this;i.rootel.on("change",".student-select",function(e){var n=r(this).find(":selected").data("markurl");n&&window.location.replace(n)}),i.rootel.on("change",".task-select",function(e){var n=r(this).find(":selected").data("markurl");n&&window.location.replace(n)}),i.rootel.on("change",".group-select",function(e){var n=r(this).find(":selected").data("markurl");n&&window.location.replace(n)}),i.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=r(this);i.selectLevel(e),c.debug("Adding leave page check..."),window.onbeforeunload=function(){return"You have unsaved changes!"}}),i.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,i.regenerateCriterionJSON(),i.rootel.find('[name="action"]').val("save"),i.form.submit()}),i.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,i.regenerateCriterionJSON(),i.rootel.find('[name="action"]').val("saveshownext"),i.form.submit()}),i.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,i.rootel.find('[name="action"]').val("reset"),i.form.submit()}),i.rootel.on("click","#save-to-comment-bank",function(e){e.preventDefault(),i.saveComment()}),i.rootel.on("click",".comment",function(e){e.preventDefault();var n=r(this).find(".text").html(),e=i.rootel.find("#id_comment");e.val()&&(n=e.val()+"\n"+n),e.val(n)}),i.rootel.on("click",".comment .delete",function(e){e.preventDefault(),e.stopPropagation();e=r(this);i.deleteComment(e)}),i.rootel.find(".myconnect-selector .frame").scroll(function(){var e=r(this);clearTimeout(n),n=setTimeout(function(){e.scrollTop()+e.innerHeight()>=e[0].scrollHeight&&i.loadNextMyConnectPosts()},500)});var t=setInterval(function(){var e=i.rootel.find(".myconnect-selector .frame"),n=e.innerHeight(),o=e[0].scrollHeight,e=i.rootel.find('input[name="myconnectnextpage"]').val();o<n&&0<e?i.loadNextMyConnectPosts():clearTimeout(t)},3e3);i.rootel.on("click",".myconnect-selector .btn-exit",function(e){i.closeMyConnectSelector()}),i.rootel.on("click",".myconnect-evidence .btn-browse",function(e){i.rootel.find(".myconnect-selector").show(),r("body").css("overflow","hidden"),"undefined"!=typeof Masonry&&void 0===i.msnry&&(i.msnry=new Masonry(".myconnect-selector .posts",{itemSelector:".post-wrap",columnWidth:10,horizontalOrder:!0}))}),i.rootel.on("mousedown",".myconnect-selector .post",function(e){var n=r(this);n.hasClass("selected")?n.removeClass("selected"):n.addClass("selected");n=i.rootel.find(".myconnect-selector .btn-add");n.addClass("disabled"),i.rootel.find(".myconnect-selector .post.selected").length&&n.removeClass("disabled")}),i.rootel.on("click",".myconnect-selector .btn-add",function(e){var n=i.rootel.find(".myconnect-selector .post.selected");n.removeClass("selected");var o=i.rootel.find(".myconnect-carousel"),t=r('input[name="myconnectevidencejson"]'),a=new Array;n.each(function(){var e=r(this);a.push(e.data("id")),o.append(e)});n="";a.length&&(n=JSON.stringify(a),t.val(n)),i.closeMyConnectSelector()})},t.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},t.prototype.regenerateCriterionJSON=function(){var e=r('input[name="criterionjson"]'),o=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=r(this),n=e.find(".level.selected").first().data("level");void 0===n&&(n=0);n={id:e.data("id"),selectedlevel:n};o.push(n)});var n="";return o.length&&(n=JSON.stringify(o),e.val(n)),n},t.prototype.saveComment=function(){var n,e=this.rootel.find('textarea[name="comment"]');e.val().length&&((n=this.rootel.find(".comment-bank")).addClass("submitting"),e={comment:e.val(),taskid:this.taskid},i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_comment",data:JSON.stringify(e)},done:function(e){n.find(".stored").html(e),n.removeClass("submitting")},fail:function(e){c.debug(e)}}]))},t.prototype.deleteComment=function(e){var n=e.closest(".comment");n.css("opacity","0.4"),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_comment",data:n.data("id")},done:function(e){n.fadeOut(300,function(){r(this).remove()})},fail:function(e){c.debug(e)}}])},t.prototype.loadNextMyConnectPosts=function(){var o,t,e,a=this;a.loadingmyconnect||(a.loadingmyconnect=!0,o=a.rootel.find('input[name="myconnectnextpage"]'),t=a.rootel.find(".myconnect-selector .posts"),e={username:a.rootel.find(".selected-student").data("username"),page:o.val()},i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"load_next_myconnect_posts",data:JSON.stringify(e)},done:function(e){var n=r(e);t.append(n),void 0!==a.msnry&&a.msnry.appended(n),e?(o.val(o.val()+1),a.loadingmyconnect=!1):o.val(-1)},fail:function(e){c.debug(e),a.loadingmyconnect=!1}}]))},t.prototype.closeMyConnectSelector=function(){this.rootel.find(".myconnect-selector").hide(),r("body").css("overflow","")},{init:function(e,n){c.debug("mod_psgrading/mark: initializing");var o=r("#page-mod-psgrading-mark");o.length?new t(o,e,n).main():c.error("mod_psgrading/mark: #page-mod-psgrading-mark not found!")}}});