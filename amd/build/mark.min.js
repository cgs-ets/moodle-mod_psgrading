define(["jquery","core/log","core/ajax"],function(c,r,l){"use strict";function a(e,t,n,o){var a=this;a.rootel=e,a.form=a.rootel.find('form[data-form="psgrading-mark"]'),a.userid=t,a.taskid=n,a.quickmark=o,a.loadingmyconnect=!1}return a.prototype.main=function(){var t,o=this;o.rootel.on("change",".student-select",function(e){var t=c(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("change",".task-select",function(e){var t=c(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("change",".group-select",function(e){var t=c(this).find(":selected").data("markurl");t&&window.location.replace(t)}),o.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=c(this);o.selectLevel(e),r.debug("Adding leave page check..."),window.onbeforeunload=function(){return"You have unsaved changes!"}}),o.rootel.on("click",'input[name="save"]',function(e){window.onbeforeunload=null,o.regenerateCriterionJSON(),o.regenerateEngagementJSON(),o.rootel.find('[name="action"]').val("save")}),o.rootel.on("click","#quickmarksave",function(e){e.preventDefault();var t=c(this);t.html("Saving... please wait"),t.prop("disabled",!0),o.regenerateCriterionJSON();var n=o.regenerateEngagementJSON(),e=c('form[data-form="psgrading-mark"]').serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});e.taskid=o.taskid,e.userid=o.userid,e.engagement=n,l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_mark",data:JSON.stringify(e)},done:function(e){e&&1<=e&&(t.html("Success"),t.addClass("btn-success"),setTimeout(function(){t.removeClass("btn-success"),t.html("Save and show next"),t.prop("disabled",!1),window.top.postMessage("saveshownext","*")},800))},fail:function(e){alert(e),t.html("Save and show next"),t.prop("disabled",!1),r.debug(e)}}])}),o.rootel.on("click",'input[name="saveshownext"]',function(e){window.onbeforeunload=null,o.regenerateCriterionJSON(),o.regenerateEngagementJSON(),o.rootel.find('[name="action"]').val("saveshownext")}),o.rootel.on("click",'input[name="cancel"]',function(e){window.onbeforeunload=null,o.rootel.find('[name="action"]').val("cancel")}),o.rootel.on("click","#save-to-comment-bank",function(e){e.preventDefault(),o.saveComment()}),o.rootel.on("click",".comment",function(e){e.preventDefault();var t=c(this).find(".text").html(),e=o.rootel.find("#id_comment");e.val()&&(t=e.val()+"\n"+t),e.val(t)}),o.rootel.on("click",".comment .delete",function(e){e.preventDefault(),e.stopPropagation();e=c(this);o.deleteComment(e)}),o.rootel.find(".myconnect-selector .frame").scroll(function(){var e=c(this);clearTimeout(t),t=setTimeout(function(){e.scrollTop()+e.innerHeight()>=e[0].scrollHeight&&o.loadNextMyConnectAttachments()},500)}),o.rootel.on("click",".myconnect-selector .btn-exit",function(e){e.preventDefault(),o.closeMyConnectSelector()}),o.rootel.on("click","#myconnect-evidence .btn-browse",function(e){e.preventDefault(),o.openMyConnectSelector()}),o.rootel.on("mousedown",".myconnect-selector .attachment",function(e){var t=c(this);t.hasClass("selected")?t.removeClass("selected"):t.addClass("selected");t=o.rootel.find(".myconnect-selector .btn-add");t.addClass("disabled"),o.rootel.find(".myconnect-selector .attachment.selected").length&&t.removeClass("disabled")}),o.rootel.on("click",".myconnect-selector .btn-add",function(e){e.preventDefault(),o.addMyConnectAttachments()}),o.rootel.on("click",".myconnect-carousel .selector",function(e){e.preventDefault();e=c(this);o.removeMyConnectAttachment(e)}),o.rootel.find('input[name="didnotsubmit"]').change(function(){this.checked?o.rootel.addClass("didnotsubmit"):o.rootel.removeClass("didnotsubmit")})},a.prototype.selectLevel=function(e){var t=e.closest(".criterion");e.hasClass("selected")?t.find(".level").removeClass("selected"):(t.find(".level").removeClass("selected"),e.addClass("selected"))},a.prototype.regenerateCriterionJSON=function(){var e=c('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=c(this),t=e.find(".level.selected").first().data("level");void 0===t&&(t=0);t={id:e.data("id"),selectedlevel:t};n.push(t)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},a.prototype.regenerateEngagementJSON=function(){var e=c('input[name="engagementjson"]'),n=new Array,o=0,t=null!=document.querySelector(".hide-engagement");this.rootel.find(".engagement.tbl-tr").each(function(){var e=c(this),t=e.find(".level.selected").first().data("level");void 0===t&&(t=0);e={id:e.data("id"),selectedlevel:t};n.push(e),o+=Number(t)});var a="";n.length&&(a=JSON.stringify(n),e.val(a));a="";return t&&(a=["","E","VG","A","NI"][o=Math.ceil(o/n.length)]),a},a.prototype.saveComment=function(){var t,e=this.rootel.find('textarea[name="comment"]');e.val().length&&((t=this.rootel.find(".comment-bank")).addClass("submitting"),e={comment:e.val(),taskid:this.taskid},l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_comment",data:JSON.stringify(e)},done:function(e){t.find(".stored").html(e),t.removeClass("submitting")},fail:function(e){r.debug(e)}}]))},a.prototype.deleteComment=function(e){var t=e.closest(".comment");t.css("opacity","0.4"),l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_comment",data:t.data("id")},done:function(e){t.fadeOut(300,function(){c(this).remove()})},fail:function(e){r.debug(e)}}])},a.prototype.loadNextMyConnectAttachments=function(){var n,o,e,a=this;a.loadingmyconnect||(a.loadingmyconnect=!0,n=a.rootel.find('input[name="myconnectnextpage"]'),o=a.rootel.find(".myconnect-selector .attachments"),e=a.rootel.find('input[name="selectedmyconnectjson"]'),e={username:a.rootel.find(".selected-student").data("username"),page:n.val(),selectedmyconnectfiles:e.val()},l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"load_next_myconnect_attachments",data:JSON.stringify(e)},done:function(e){var t=c(e);o.append(t),void 0!==a.msnry&&(a.msnry.appended(t),imagesLoaded(document.querySelector(".myconnect-selector"),function(e){a.msnry.layout()})),e?n.val(parseInt(n.val())+1):n.val(-1),a.loadingmyconnect=!1},fail:function(e){r.debug(e),a.loadingmyconnect=!1}}]))},a.prototype.openMyConnectSelector=function(){var e=this;e.rootel.find(".myconnect-selector").show(),c("body").css("overflow","hidden"),"undefined"!=typeof Masonry&&void 0===e.msnry?e.msnry=new Masonry(".myconnect-selector .attachments",{itemSelector:".attachment-wrap",columnWidth:10,horizontalOrder:!0}):e.msnry.layout();var t=e.rootel.find('input[name="myconnectevidencejson"]');if(t.val()&&'[""]'!=t.val()){var n=JSON.parse(t.val());for(i=0;i<n.length;i++){var o=n[i];e.rootel.find('.myconnect-selector .attachment[data-id="'+o+'"]').addClass("selected")}}e.loadNextMyConnectAttachments()},a.prototype.closeMyConnectSelector=function(){this.rootel.find(".myconnect-selector").hide(),c("body").css("overflow",""),document.getElementById("myconnect-evidence").scrollIntoView(),this.rootel.find(".myconnect-selector .attachment").removeClass("selected")},a.prototype.addMyConnectAttachments=function(){var e=this,t=e.rootel.find(".myconnect-selector .attachment.selected");t.removeClass("selected");var n=e.rootel.find(".myconnect-carousel");n.html("");var o=new Array;t.each(function(){var e=c(this).clone();o.push(e.data("id")),n.append(e)});var o=o.filter(e.onlyUnique),a=e.rootel.find('input[name="myconnectevidencejson"]'),t="";o.length&&(t=JSON.stringify(o),a.val(t)),e.updateCarousel(),e.closeMyConnectSelector()},a.prototype.removeMyConnectAttachment=function(e){var t=e.closest(".attachment").data("id"),n=this.rootel.find('input[name="myconnectevidencejson"]'),e=JSON.parse(n.val()),e=this.removeFromArray(e,t),e=JSON.stringify(e);n.val(e),this.rootel.find('.myconnect-carousel .attachment[data-id="'+t+'"]').remove(),this.updateCarousel()},a.prototype.updateCarousel=function(){var e=this.rootel.find("#myconnect-evidence");e.removeClass("has-attachments"),e.find(".attachment").length&&e.addClass("has-attachments")},a.prototype.onlyUnique=function(e,t,n){return n.indexOf(e)===t},a.prototype.removeFromArray=function(e,t){t=e.indexOf(t);return-1!==t&&e.splice(t,1),e},{init:function(e,t,n){r.debug("mod_psgrading/mark: initializing");var o=c("#page-mod-psgrading-mark");o.length?new a(o,e,t,n).main():r.error("mod_psgrading/mark: #page-mod-psgrading-mark not found!")}}});