define(["jquery","core/log","core/templates","core/ajax","core/str"],function(i,a,e){"use strict";function r(e,t,n){var i=this;i.rootel=e,i.userid=t,i.taskid=n}return r.prototype.main=function(){var e=this;e.loadMarks(),e.rootel.on("click","#btn-save",function(e){e.preventDefault()}),e.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault()}),e.rootel.on("click","#btn-reset",function(e){e.preventDefault()})},r.prototype.loadMarks=function(){e.call([{methodname:"mod_psgrading_loadmarks",args:{taskid:this.taskid,userid:this.userid},done:function(){},fail:function(e){a.debug(e)}}])},r.prototype.regenerateEvidenceJSON=function(){var e=i('input[name="evidencejson"]'),t=new Array;this.rootel.find(".evidence-selector .activity .cmid:checked").each(function(){var e={type:"cm",data:i(this).val()};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},r.prototype.regenerateCriterionJSON=function(){var e=i('input[name="criterionjson"]'),t=new Array;this.rootel.find(".criterions .tbl-tr").each(function(){var e=i(this),e={description:e.find("[name=description]").val(),level2:e.find("[name=level2]").val(),level3:e.find("[name=level3]").val(),level4:e.find("[name=level4]").val(),subject:e.find("[name=subject]").val(),weight:e.find("[name=weight]").val(),hidden:e.find("[name=hidden]").is(":checked")?0:1};t.push(e)});var n="";return t.length&&(n=JSON.stringify(t),e.val(n)),n},r.prototype.addCriterion=function(){var t=this,e={criterions:[t.stubcriterion]};Templates.render(t.templates.CRITERION,e).done(function(e){t.rootel.find(".criterions").append(e)})},r.prototype.toggleCriterion=function(e){var t=e.closest(".hidden-control"),n=t.closest(".tbl-tr"),e=t.find("input"),t=t.find(".desc");e.is(":checked")?(e.prop("checked",!1),n.addClass("criterion-hidden"),t.html("Hidden from students")):(e.prop("checked",!0),n.removeClass("criterion-hidden"),t.html("Visible")),this.autosaving=!1,this.regenerateAndSave()},r.prototype.deleteCriterion=function(e){var t=this;e.closest(".tbl-tr").fadeOut(200,function(){i(this).remove(),t.autosaving=!1,t.regenerateAndSave()})},r.prototype.statusSaving=function(){this.autosaving=!0,this.savestatus.html('<div class="badge badge-secondary"><div class="spinner"><div class="circle spin"></div></div> Auto saving</div>'),window.onbeforeunload=function(){return"Are you sure?"}},r.prototype.statusSaved=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-check" aria-hidden="true"></i> Draft saved</div>'),window.onbeforeunload=null},r.prototype.statusSaveFailed=function(){this.autosaving=!1,this.savestatus.html('<div class="badge badge-secondary"><i class="fa fa-cross" aria-hidden="true"></i> Changes unsaved</div>'),window.onbeforeunload=function(){return"Are you sure?"}},r.prototype.loadTemplate=function(e){return Templates.render(this.templates[e],{})},{init:function(e,t){a.debug("mod_psgrading/mark: initializing");var n=i(".mod_psgrading_mark");n.length?new r(n,e,t).main():a.error("mod_psgrading/mark: .mod_psgrading_mark not found!")}}});