define(["jquery","core/log","core/ajax"],function(a,c,l){"use strict";function n(e,o,t){var n=this;n.rootel=e,n.form=n.rootel.find('form[data-form="psgrading-mark"]'),n.userid=o,n.taskid=t,n.loadingmyconnect=!1}return n.prototype.main=function(){var o,n=this;n.rootel.on("change",".student-select",function(e){var o=a(this).find(":selected").data("markurl");o&&window.location.replace(o)}),n.rootel.on("change",".task-select",function(e){var o=a(this).find(":selected").data("markurl");o&&window.location.replace(o)}),n.rootel.on("change",".group-select",function(e){var o=a(this).find(":selected").data("markurl");o&&window.location.replace(o)}),n.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=a(this);n.selectLevel(e),c.debug("Adding leave page check..."),window.onbeforeunload=function(){return"You have unsaved changes!"}}),n.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("save"),n.form.submit()}),n.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("saveshownext"),n.form.submit()}),n.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("reset"),n.form.submit()}),n.rootel.on("click","#save-to-comment-bank",function(e){e.preventDefault(),n.saveComment()}),n.rootel.on("click",".comment",function(e){e.preventDefault();var o=a(this).find(".text").html(),e=n.rootel.find("#id_comment");e.val()&&(o=e.val()+"\n"+o),e.val(o)}),n.rootel.on("click",".comment .delete",function(e){e.preventDefault(),e.stopPropagation();e=a(this);n.deleteComment(e)}),n.rootel.find(".myconnect-selector .frame").scroll(function(){var e=a(this);clearTimeout(o),o=setTimeout(function(){e.scrollTop()+e.innerHeight()>=e[0].scrollHeight&&n.loadNextMyConnectPosts()},500)});var r=setInterval(function(){var e=n.rootel.find(".myconnect-selector .frame"),o=e.innerHeight(),t=e[0].scrollHeight,e=n.rootel.find('input[name="myconnectnextpage"]').val();t<o&&0<e?n.loadNextMyConnectPosts():clearTimeout(r)},3e3);n.rootel.on("click",".myconnect-selector .btn-exit",function(e){e.preventDefault(),n.closeMyConnectSelector()}),n.rootel.on("click","#myconnect-evidence .btn-browse",function(e){e.preventDefault(),n.openMyConnectSelector()}),n.rootel.on("mousedown",".myconnect-selector .post",function(e){var o=a(this);o.hasClass("selected")?o.removeClass("selected"):o.addClass("selected");o=n.rootel.find(".myconnect-selector .btn-add");o.addClass("disabled"),n.rootel.find(".myconnect-selector .post.selected").length&&o.removeClass("disabled")}),n.rootel.on("click",".myconnect-selector .btn-add",function(e){e.preventDefault(),n.addMyConnectPosts()}),n.rootel.on("click",".myconnect-carousel .selector",function(e){e.preventDefault();e=a(this);n.removeMyConnectPost(e)})},n.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},n.prototype.regenerateCriterionJSON=function(){var e=a('input[name="criterionjson"]'),t=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=a(this),o=e.find(".level.selected").first().data("level");void 0===o&&(o=0);o={id:e.data("id"),selectedlevel:o};t.push(o)});var o="";return t.length&&(o=JSON.stringify(t),e.val(o)),o},n.prototype.saveComment=function(){var o,e=this.rootel.find('textarea[name="comment"]');e.val().length&&((o=this.rootel.find(".comment-bank")).addClass("submitting"),e={comment:e.val(),taskid:this.taskid},l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_comment",data:JSON.stringify(e)},done:function(e){o.find(".stored").html(e),o.removeClass("submitting")},fail:function(e){c.debug(e)}}]))},n.prototype.deleteComment=function(e){var o=e.closest(".comment");o.css("opacity","0.4"),l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_comment",data:o.data("id")},done:function(e){o.fadeOut(300,function(){a(this).remove()})},fail:function(e){c.debug(e)}}])},n.prototype.loadNextMyConnectPosts=function(){var t,n,e,r=this;r.loadingmyconnect||(r.loadingmyconnect=!0,t=r.rootel.find('input[name="myconnectnextpage"]'),n=r.rootel.find(".myconnect-selector .posts"),e={username:r.rootel.find(".selected-student").data("username"),page:t.val()},l.call([{methodname:"mod_psgrading_apicontrol",args:{action:"load_next_myconnect_posts",data:JSON.stringify(e)},done:function(e){var o=a(e);n.append(o),void 0!==r.msnry&&r.msnry.appended(o),e?(t.val(t.val()+1),r.loadingmyconnect=!1):t.val(-1)},fail:function(e){c.debug(e),r.loadingmyconnect=!1}}]))},n.prototype.openMyConnectSelector=function(){var e=this;e.rootel.find(".myconnect-selector").show(),a("body").css("overflow","hidden"),"undefined"!=typeof Masonry&&void 0===e.msnry&&(e.msnry=new Masonry(".myconnect-selector .posts",{itemSelector:".post-wrap",columnWidth:10,horizontalOrder:!0}));var o=e.rootel.find('input[name="myconnectevidencejson"]');if(o.val()){var t=JSON.parse(o.val());for(i=0;i<t.length;i++){var n=t[i];e.rootel.find('.myconnect-selector .post[data-id="'+n+'"]').addClass("selected"),console.log(n)}}},n.prototype.closeMyConnectSelector=function(){this.rootel.find(".myconnect-selector").hide(),a("body").css("overflow",""),document.getElementById("myconnect-evidence").scrollIntoView()},n.prototype.addMyConnectPosts=function(){var e=this,o=e.rootel.find(".myconnect-selector .post.selected");o.removeClass("selected");var t=e.rootel.find(".myconnect-carousel");t.html("");var n=new Array;o.each(function(){var e=a(this).clone();n.push(e.data("id")),t.append(e)});var n=n.filter(e.onlyUnique),r=e.rootel.find('input[name="myconnectevidencejson"]'),o="";n.length&&(o=JSON.stringify(n),r.val(o)),e.updateCarousel(),e.closeMyConnectSelector()},n.prototype.removeMyConnectPost=function(e){var o=e.closest(".post").data("id"),t=this.rootel.find('input[name="myconnectevidencejson"]'),e=JSON.parse(t.val()),e=this.removeFromArray(e,o),e=JSON.stringify(e);t.val(e),this.rootel.find('.myconnect-carousel .post[data-id="'+o+'"]').remove(),this.updateCarousel()},n.prototype.updateCarousel=function(){this.rootel.find(".myconnect-carousel");carousel.removeClass("has-posts"),carousel.find(".post").length&&carousel.addClass("has-posts")},n.prototype.onlyUnique=function(e,o,t){return t.indexOf(e)===o},n.prototype.removeFromArray=function(e,o){o=e.indexOf(o);return-1!==o&&e.splice(o,1),e},{init:function(e,o){c.debug("mod_psgrading/mark: initializing");var t=a("#page-mod-psgrading-mark");t.length?new n(t,e,o).main():c.error("mod_psgrading/mark: #page-mod-psgrading-mark not found!")}}});