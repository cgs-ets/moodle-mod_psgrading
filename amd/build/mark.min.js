define(["jquery","core/log","core/ajax"],function(o,a,i){"use strict";function r(e,t,n){var o=this;o.rootel=e,o.form=o.rootel.find('form[data-form="psgrading-mark"]'),o.userid=t,o.taskid=n}return r.prototype.main=function(){var n=this;n.rootel.on("change",".student-select",function(e){var t=o(this).find(":selected").data("markurl");t&&window.location.replace(t)}),n.rootel.on("change",".task-select",function(e){var t=o(this).find(":selected").data("markurl");t&&window.location.replace(t)}),n.rootel.on("click",".criterions .level",function(e){e.preventDefault();e=o(this);n.selectLevel(e),a.debug("Adding leave page check..."),window.onbeforeunload=function(){return"You have unsaved changes!"}}),n.rootel.on("click","#btn-save",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("save"),n.form.submit()}),n.rootel.on("click","#btn-saveshownext",function(e){e.preventDefault(),window.onbeforeunload=null,n.regenerateCriterionJSON(),n.rootel.find('[name="action"]').val("saveshownext"),n.form.submit()}),n.rootel.on("click","#btn-reset",function(e){e.preventDefault(),window.onbeforeunload=null,n.rootel.find('[name="action"]').val("reset"),n.form.submit()}),n.rootel.on("click","#save-to-comment-bank",function(e){e.preventDefault(),n.saveComment()}),n.rootel.on("click",".comment",function(e){e.preventDefault();var t=o(this).find(".text").html(),e=n.rootel.find("#id_comment");e.val()&&(t=e.val()+"\n"+t),e.val(t)}),n.rootel.on("click",".comment .delete",function(e){e.preventDefault(),e.stopPropagation();e=o(this);n.deleteComment(e)})},r.prototype.selectLevel=function(e){e.closest(".criterion").find(".level").removeClass("selected"),e.addClass("selected")},r.prototype.regenerateCriterionJSON=function(){var e=o('input[name="criterionjson"]'),n=new Array;this.rootel.find(".criterion.tbl-tr").each(function(){var e=o(this),t=e.find(".level.selected").first().data("level");void 0===t&&(t=0);t={id:e.data("id"),selectedlevel:t};n.push(t)});var t="";return n.length&&(t=JSON.stringify(n),e.val(t)),t},r.prototype.saveComment=function(){var t,e=this,n=e.rootel.find('textarea[name="comment"]');n.val().length&&((t=e.rootel.find(".comment-bank")).addClass("submitting"),e={comment:n.val(),taskid:e.taskid},i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"save_comment",data:JSON.stringify(e)},done:function(e){t.find(".stored").html(e),t.removeClass("submitting")},fail:function(e){a.debug(e)}}]))},r.prototype.deleteComment=function(e){var t=e.closest(".comment");t.css("opacity","0.4"),i.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_comment",data:t.data("id")},done:function(e){t.fadeOut(300,function(){o(this).remove()})},fail:function(e){a.debug(e)}}])},{init:function(e,t){a.debug("mod_psgrading/mark: initializing");var n=o("#page-mod-psgrading-mark");n.length?new r(n,e,t).main():a.error("mod_psgrading/mark: #page-mod-psgrading-mark not found!")}}});