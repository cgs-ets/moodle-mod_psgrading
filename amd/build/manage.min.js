define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(e,o,n,d,i){"use strict";function t(a){this.rootel=a}return t.prototype.main=function(){var t=this;t.rootel.on("click",".action-release",function(a){a.preventDefault();a=e(this);t.releaseTask(a)}),t.rootel.on("click",".action-undorelease",function(a){a.preventDefault();a=e(this);t.unreleaseTask(a)}),t.rootel.on("click",".action-discarddraft",function(a){a.preventDefault();a=e(this);t.showDeleteDraft(a)}),"undefined"!=typeof Sortable&&(a=document.getElementById("task-list"),new Sortable(a,{handle:".btn-reorder",animation:150,ghostClass:"reordering",onEnd:t.SortEnd})),t.modals={DIFF:null};var a=[];a.push(t.loadModal("DIFF","Review draft changes and confirm deletion","Delete draft",d.types.SAVE_CANCEL)),e.when.apply(e,a).then(function(){t.rootel.removeClass("preloading").addClass("preloads-completed")})},t.prototype.showDeleteDraft=function(a){var t=this;t.modals.DIFF&&((a=a.closest(".task")).hasClass("not-published")?t.deleteDraft(a.data("id")):(n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_diff",data:a.data("id")},done:function(a){t.modals.DIFF.setBody(a)},fail:function(a){return o.debug(a),"Failed to load diff."}}]),t.modals.DIFF.getModal().addClass("modal-xl"),t.modals.DIFF.getRoot().on(i.save,{self:t,taskid:a.data("id")},t.handleDeleteDraft),t.modals.DIFF.show()))},t.prototype.handleDeleteDraft=function(a){var t=a.data.self,a=a.data.taskid;t.deleteDraft(a)},t.prototype.deleteDraft=function(a){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_draft",data:a},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},t.prototype.releaseTask=function(a){a=a.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},t.prototype.unreleaseTask=function(a){a=a.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:a.data("id")},done:function(){window.location.reload(!1)},fail:function(a){o.debug(a)}}])},t.prototype.SortEnd=function(a){var t=new Array;e("#task-list .task").each(function(){t.push(e(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(t)},done:function(){},fail:function(a){o.debug(a)}}])},t.prototype.loadModal=function(t,e,o,a){var n=this;return d.create({type:a}).then(function(a){a.setTitle(e),o&&a.setSaveButtonText(o),(n.modals[t]=a).getBackdrop(),a.getRoot().addClass("modal-"+t)})},{init:function(){o.debug("mod_psgrading/manage: initializing");var a=e("#page-mod-psgrading-manage");a.length?new t(a).main():o.error("mod_psgrading/manage: #page-mod-psgrading-manage not found!")}}});