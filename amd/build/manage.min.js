define(["jquery","core/log","core/ajax","core/modal_factory","core/modal_events"],function(e,o,n,d,i){"use strict";function a(t){this.rootel=t}return a.prototype.main=function(){var a=this;a.rootel.on("click",".action-release",function(t){t.preventDefault();t=e(this);a.releaseTask(t)}),a.rootel.on("click",".action-undorelease",function(t){t.preventDefault();t=e(this);a.unreleaseTask(t)}),a.rootel.on("click",".action-discarddraft",function(t){t.preventDefault();t=e(this);a.showDeleteDraft(t)}),"undefined"!=typeof Sortable&&(t=document.getElementById("task-list"),new Sortable(t,{handle:".btn-reorder",animation:150,ghostClass:"reordering",onEnd:a.SortEnd})),a.modals={DIFF:null};var t=[];t.push(a.loadModal("DIFF","Review draft changes and confirm deletion","Delete draft",d.types.SAVE_CANCEL)),e.when.apply(e,t).then(function(){a.rootel.removeClass("preloading").addClass("preloads-completed")})},a.prototype.showDeleteDraft=function(t){var a=this;a.modals.DIFF&&((t=t.closest(".task")).hasClass("not-published")?a.deleteDraft(t.data("id")):(n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"get_diff",data:t.data("id")},done:function(t){a.modals.DIFF.setBody(t)},fail:function(t){return o.debug(t),"Failed to load diff."}}]),a.modals.DIFF.getModal().addClass("modal-xl"),a.modals.DIFF.getRoot().on(i.save,{self:a,taskid:t.data("id")},a.handleDeleteDraft),a.modals.DIFF.show()))},a.prototype.handleDeleteDraft=function(t){var a=t.data.self,t=t.data.taskid;a.deleteDraft(t)},a.prototype.deleteDraft=function(t){n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"delete_draft",data:t},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},a.prototype.releaseTask=function(t){t=t.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"release_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},a.prototype.unreleaseTask=function(t){t=t.closest(".task");n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"unrelease_task",data:t.data("id")},done:function(){window.location.reload(!1)},fail:function(t){o.debug(t)}}])},a.prototype.SortEnd=function(t){var a=new Array;e("#task-list .task").each(function(){a.push(e(this).data("id"))}),n.call([{methodname:"mod_psgrading_apicontrol",args:{action:"reorder_tasks",data:JSON.stringify(a)},done:function(){},fail:function(t){o.debug(t)}}])},a.prototype.loadModal=function(a,e,o,t){var n=this;return d.create({type:t}).then(function(t){t.setTitle(e),o&&t.setSaveButtonText(o),(n.modals[a]=t).getBackdrop(),t.getRoot().addClass("modal-"+a)})},{init:function(){o.debug("mod_psgrading/manage: initializing");var t=e("#page-mod-psgrading-view");t.length?new a(t).main():o.error("mod_psgrading/manage: #page-mod-psgrading-view not found!")}}});